{% extends "base.html" %}

{% block title %}Анализ и оценивание рисков - Программное средство для оценки рисков ИБ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>Анализ и оценивание рисков</h2>
        <p class="text-muted">Формирование базы данных рисков ИБ</p>
        
        <div class="mb-3">
            <a href="{{ url_for('risk_assessment') }}" class="btn btn-success me-2">Оценка рисков</a>
        </div>
        
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Инцидент</th>
                        <th>Угроза</th>
                        <th>Уязвимость</th>
                        <th>Актив</th>
                        <th>Уровень последствий</th>
                        <th>Вероятность сценария</th>
                        <th>Уровень риска</th>
                        <th>Приемлемый</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody id="risks-table-body">
                    <!-- Данные будут загружаться через JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
let incidents = [];
let risks = [];
let riskAcceptanceCriteria = null;

document.addEventListener('DOMContentLoaded', function() {
    loadData();
});

function loadData() {
    // Загружаем инциденты, риски и контексты
    Promise.all([
        fetch('/api/incidents').then(response => response.json()),
        fetch('/api/risks').then(response => response.json()),
        fetch('/api/contexts').then(response => response.json())
    ])
    .then(([incidentsData, risksData, contextsData]) => {
        incidents = incidentsData;
        risks = risksData;
        
        // Загружаем критерии принятия риска из первого контекста
        if (contextsData && contextsData.length > 0 && contextsData[0].risk_acceptance_criteria) {
            try {
                riskAcceptanceCriteria = JSON.parse(contextsData[0].risk_acceptance_criteria);
                console.log('Loaded risk acceptance criteria:', riskAcceptanceCriteria);
            } catch (e) {
                console.error('Ошибка парсинга критериев принятия риска:', e);
            }
        }
        
        renderRiskList();
    })
    .catch(error => {
        console.error('Ошибка загрузки данных:', error);
        showNotification('Ошибка загрузки данных', 'danger');
    });
}

function renderRiskList() {
    const tbody = document.getElementById('risks-table-body');
    tbody.innerHTML = '';

    // Отображаем все инциденты (так же как на странице оценки рисков)
    incidents.forEach(incident => {
        // Находим соответствующий риск, если он существует
        const risk = risks.find(r => r.incident_id === incident.id);
        
        // Используем данные из инцидента для расчета
        const impactLevel = incident.impact_level;
        const scenarioProbability = incident.scenario_probability;
        
        // Определяем уровень риска и приемлемость
        let finalRiskLevel = 'Не рассчитано';
        let finalIsAcceptable = false;
        let displayLikelihood = 'Не оценено';
        let calculatedRiskScore = null;
        
        // Получаем данные для отображения и расчета
        const displayImpactLevel = impactLevel || (risk ? risk.impact_level : null);
        const probabilityValue = scenarioProbability || (risk ? risk.scenario_probability : null);
        
        if (probabilityValue) {
            displayLikelihood = getLikelihoodText(probabilityValue);
        }
        
        // Если есть данные для автоматического расчета по матрице - ВСЕГДА используем их
        if (displayImpactLevel && probabilityValue) {
            const likelihoodText = getLikelihoodText(probabilityValue);
            calculatedRiskScore = calculateRiskScore(displayImpactLevel, likelihoodText);
            finalRiskLevel = getRiskLevel(calculatedRiskScore);
            finalIsAcceptable = isRiskAcceptable(calculatedRiskScore);
        } else if (risk && risk.risk_level) {
            // Используем данные из существующего риска только если нет данных из инцидента
            finalRiskLevel = risk.risk_level;
            finalIsAcceptable = risk.risk_score ? isRiskAcceptable(risk.risk_score) : false;
        }
        
        const row = document.createElement('tr');
        const riskLevelClass = finalRiskLevel === 'низкий' ? 'success' :
                              finalRiskLevel === 'средний' ? 'warning' :
                              finalRiskLevel === 'высокий' ? 'danger' : 'secondary';
        
        row.innerHTML = `
            <td>${risk ? risk.id : '-'}</td>
            <td>Инцидент #${incident.id}</td>
            <td>${escapeHtml(incident.threat ? incident.threat.name : 'Неизвестная угроза')}</td>
            <td>${escapeHtml(incident.vulnerability ? incident.vulnerability.name : 'Неизвестная уязвимость')}</td>
            <td>${escapeHtml(incident.asset ? incident.asset.name : 'Неизвестный актив')}</td>
            <td>${escapeHtml(displayImpactLevel || 'Не оценено')}</td>
            <td>${displayLikelihood}</td>
            <td>
                <span class="badge bg-${riskLevelClass}">${finalRiskLevel}${calculatedRiskScore ? ` (${calculatedRiskScore})` : ''}</span>
            </td>
            <td>
                <span class="badge bg-${finalIsAcceptable ? 'success' : 'danger'}">${finalIsAcceptable ? 'Да' : 'Нет'}</span>
            </td>
            <td>
                ${risk ?
                    `<a href="/risks/assessment" class="btn btn-sm btn-outline-primary">Изменить</a>
                     <button class="btn btn-sm btn-outline-danger" onclick="deleteRisk(${risk.id})">Удалить</button>` :
                    `<span class="text-muted">Риск не создан</span>`
                }
            </td>
        `;
        tbody.appendChild(row);
    });
}

function deleteRisk(id) {
    confirmDelete('Вы уверены, что хотите удалить этот риск?', () => {
        fetch(`/api/risks/${id}`, { method: 'DELETE' })
            .then(response => {
                if (response.ok) {
                    showNotification('Риск успешно удален', 'success');
                    location.reload();
                } else {
                    showNotification('Ошибка при удалении риска', 'danger');
                }
            });
    });
}

function url_for(endpoint, params) {
    // Временная функция для генерации URL
    if (endpoint === 'edit_risk') {
        return '/risks/assessment'; // Перенаправляем на страницу оценки рисков
    }
    return '#';
}

function calculateRiskScore(impactLevel, likelihood) {
    // Матрица рисков (согласно таблице 3)
    const matrix = {
        'низкий': { 'низкая': 1, 'средняя': 2, 'высокая': 3 },
        'средний': { 'низкая': 2, 'средняя': 3, 'высокая': 4 },
        'высокий': { 'низкая': 3, 'средняя': 4, 'высокая': 5 }
    };

    const result = matrix[impactLevel] ? (matrix[impactLevel][likelihood] || 3) : 3;
    return result;
}

function getRiskLevel(riskScore) {
    if (riskScore <= 2) return 'низкий';
    if (riskScore <= 4) return 'средний';
    return 'высокий';
}

function getLikelihoodText(probability) {
    if (!probability) return 'Не оценено';
    if (probability <= 2) return 'низкая';
    if (probability <= 4) return 'средняя';
    return 'высокая';
}

function isRiskAcceptable(riskScore) {
    // Определяем уровень риска по баллу
    const riskLevel = getRiskLevel(riskScore);
    
    // Если есть критерии принятия риска из контекста - используем их
    if (riskAcceptanceCriteria) {
        console.log('Using risk acceptance criteria:', riskAcceptanceCriteria, 'for level:', riskLevel);
        
        if (riskLevel === 'низкий') {
            return riskAcceptanceCriteria.low === 'приемлемый';
        } else if (riskLevel === 'средний') {
            return riskAcceptanceCriteria.medium === 'приемлемый';
        } else if (riskLevel === 'высокий') {
            return riskAcceptanceCriteria.high === 'приемлемый';
        }
    }
    
    // По умолчанию: только низкий - приемлемый, средний и высокий - неприемлемый
    return riskScore <= 2;
}

function deleteRisk(id) {
    confirmDelete('Вы уверены, что хотите удалить этот риск?', () => {
        fetch(`/api/risks/${id}`, { method: 'DELETE' })
            .then(response => {
                if (response.ok) {
                    showNotification('Риск успешно удален', 'success');
                    loadData(); // Перезагружаем данные
                } else {
                    showNotification('Ошибка при удалении риска', 'danger');
                }
            });
    });
}

function url_for(endpoint, params) {
    // Временная функция для генерации URL
    if (endpoint === 'edit_risk') {
        return `/risks/${params.risk_id}/edit`;
    }
    return '#';
}

function escapeHtml(text) {
    if (!text) return '';
    return text.toString()
        .replace(/&/g, "&")
        .replace(/</g, "<")
        .replace(/>/g, ">")
        .replace(/"/g, '"')
        .replace(/'/g, "'");
}

function showNotification(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.col-12');
    container.insertBefore(alertDiv, container.firstChild);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}