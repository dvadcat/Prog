{% extends "base.html" %}

{% block title %}Идентификация угроз - Программное средство для оценки рисков ИБ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>Идентификация и определение вероятности реализации угроз</h2>
        <p class="text-muted">Формирование базы данных актуальных угроз</p>
        
        <div class="mb-3">
            <a href="{{ url_for('create_threat') }}" class="btn btn-primary me-2">Создать угрозу</a>
            <a href="{{ url_for('select_threats') }}" class="btn btn-success me-2">Выбрать угрозы для анализа</a>
            
        
        </div>
        
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Наименование</th>
                        <th>Источник</th>
                        <th>Актуальная</th>
                        <th>Вероятность</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody id="threats-table-body">
                    <!-- Данные будут загружаться через JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Загрузка списка угроз
    fetchData('/api/threats')
        .then(data => {
            if (data) {
                const tbody = document.getElementById('threats-table-body');
                tbody.innerHTML = '';
                
                data.forEach(threat => {
                    const row = document.createElement('tr');
                    const relevantBadge = threat.is_relevant 
                        ? '<span class="badge bg-success">Да</span>' 
                        : '<span class="badge bg-secondary">Нет</span>';
                    row.innerHTML = `
                        <td>${threat.id}</td>
                        <td>${threat.name}</td>
                        <td>${threat.source || ''}</td>
                        <td>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="relevant-${threat.id}" 
                                    ${threat.is_relevant ? 'checked' : ''} 
                                    onchange="toggleRelevance(${threat.id}, this.checked)">
                            </div>
                        </td>
                        <td>${threat.likelihood || 'Не оценено'}</td>
                        <td>
                            <a href="/threats/${threat.id}/edit-wizard" class="btn btn-sm btn-outline-primary">Изменить</a>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteThreat(${threat.id})">Удалить</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
        });
});

function toggleRelevance(threatId, isRelevant) {
    fetch(`/api/threats/${threatId}/relevance`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ is_relevant: isRelevant })
    })
    .then(response => {
        if (response.ok) {
            showNotification(isRelevant ? 'Угроза отмечена как актуальная' : 'Угроза отмечена как неактуальная', 'success');
        } else {
            showNotification('Ошибка при обновлении статуса', 'danger');
            // Вернуть переключатель в исходное состояние
            document.getElementById(`relevant-${threatId}`).checked = !isRelevant;
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        showNotification('Ошибка при обновлении статуса', 'danger');
        document.getElementById(`relevant-${threatId}`).checked = !isRelevant;
    });
}

function deleteThreat(id) {
    confirmDelete('Вы уверены, что хотите удалить эту угрозу?', () => {
        fetch(`/api/threats/${id}`, { method: 'DELETE' })
            .then(response => {
                if (response.ok) {
                    showNotification('Угроза успешно удалена', 'success');
                    location.reload();
                } else {
                    showNotification('Ошибка при удалении угрозы', 'danger');
                }
            });
    });
}
</script>
{% endblock %}