{% extends "base.html" %}

{% block title %}Уязвимости защищаемых активов{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>Уязвимости защищаемых активов</h2>

        <div id="asset-selection" class="mb-3">
            <h5>Выберите активы для включения в таблицу</h5>
            <div id="assets-list"></div>
            <button class="btn btn-success" onclick="confirmSelection()">Подтвердить выбор</button>
        </div>

        <div id="table-container" style="display: none;">
        </div>

        <div class="mt-3">
            <button class="btn btn-primary" id="next-button" style="display: none;" onclick="nextStep()">Далее</button>
        </div>
    </div>
</div>

<script>
let selectedAssets = [];
let allVulnerabilities = [];

document.addEventListener('DOMContentLoaded', function() {
    loadAssetsForSelection();
    loadVulnerabilities();
});

function loadAssetsForSelection() {
    // Словарь для перевода типов активов
    const typeTranslations = {
        'information': 'Информационный',
        'software': 'Программный',
        'hardware': 'Аппаратный'
    };
    
    fetch('/api/assets/')
        .then(response => response.json())
        .then(assets => {
            const container = document.getElementById('assets-list');
            container.innerHTML = '';
            assets.forEach(asset => {
                const translatedType = typeTranslations[asset.type] || asset.type;
                const div = document.createElement('div');
                div.className = 'form-check';
                div.innerHTML = `
                    <input class="form-check-input" type="checkbox" id="asset-${asset.id}" value="${asset.id}">
                    <label class="form-check-label" for="asset-${asset.id}">
                        ${asset.name} (${translatedType})
                    </label>
                `;
                container.appendChild(div);
            });
        })
        .catch(error => console.error('Ошибка загрузки активов:', error));
}

function loadVulnerabilities() {
    fetch('/api/vulnerabilities')
        .then(response => response.json())
        .then(vuls => {
            allVulnerabilities = vuls;
        })
        .catch(error => console.error('Ошибка загрузки уязвимостей:', error));
}


function confirmSelection() {
    selectedAssets = [];
    document.querySelectorAll('#assets-list input[type="checkbox"]:checked').forEach(cb => {
        selectedAssets.push(parseInt(cb.value));
    });
    if (selectedAssets.length === 0) {
        alert('Выберите хотя бы один актив');
        return;
    }
    const assetSelection = document.getElementById('asset-selection');
    if (assetSelection) assetSelection.style.display = 'none';
    buildTable();

    const nextBtn = document.getElementById('next-button');
    if (nextBtn) nextBtn.style.display = 'inline-block';
}

function buildTable() {
    const assetPromises = selectedAssets.map(assetId => fetch(`/api/assets/${assetId}`).then(r => r.json()));

    Promise.all(assetPromises).then(assets => {
        // Группировка по типу
        const grouped = {};
        assets.forEach(asset => {
            const type = asset.type;
            if (!grouped[type]) grouped[type] = [];
            grouped[type].push(asset);
        });

        buildGroupedTables(grouped);
    }).catch(error => {
        console.error('Ошибка загрузки активов:', error);
        alert('Ошибка загрузки активов: ' + error);
    });
}

function buildGroupedTables(grouped) {
    const container = document.getElementById('table-container');
    if (!container) {
        console.error('table-container not found');
        alert('Элемент table-container не найден');
        return;
    }
    container.innerHTML = '';
    
    // Перевод типов на русский
    const typeNames = {
        'information': 'Информационные активы',
        'software': 'Программные средства',
        'hardware': 'Аппаратные средства'
    };

    for (const [type, assets] of Object.entries(grouped)) {
        const section = document.createElement('div');
        section.className = 'mb-4';
        section.innerHTML = `<h5>${typeNames[type] || type}</h5>`;

        const table = document.createElement('table');
        table.className = 'table table-bordered';
        table.innerHTML = `
            <thead>
                <tr>
                    <th>Актив</th>
                    <th>Уязвимости</th>
                </tr>
            </thead>
            <tbody id="tbody-${type.replace(/\s/g, '-')}">
            </tbody>
        `;

        const tbody = table.querySelector('tbody');
        assets.forEach(asset => {
            const row = document.createElement('tr');

            // Актив
            const assetCell = document.createElement('td');
            assetCell.innerHTML = `<strong>${asset.name}</strong>`;
            row.appendChild(assetCell);

            // Уязвимости
            const vulCell = document.createElement('td');
            const vulSelect = document.createElement('select');
            vulSelect.className = 'form-select';
            vulSelect.multiple = true;
            vulSelect.setAttribute('data-asset', asset.id);
            vulSelect.innerHTML = '<option value="">Выберите уязвимости...</option>' +
                allVulnerabilities.map(v => `<option value="${v.id}">${v.name}</option>`).join('');
            vulCell.appendChild(vulSelect);
            row.appendChild(vulCell);

            tbody.appendChild(row);
        });

        section.appendChild(table);
        container.appendChild(section);
    }

    const tableContainer = document.getElementById('table-container');
    if (tableContainer) tableContainer.style.display = 'block';
}

function nextStep() {
    // Сохранить данные таблицы
    const tableData = [];
    document.querySelectorAll('select[data-asset]').forEach(select => {
        const assetId = parseInt(select.getAttribute('data-asset'));
        const vuls = Array.from(select.selectedOptions).map(opt => opt.value);
        tableData.push({ asset_id: assetId, vulnerabilities: vuls });
    });
    localStorage.setItem('vulnerability_table', JSON.stringify(tableData));

    window.location.href = '/vulnerabilities/step2';
}
</script>
{% endblock %}