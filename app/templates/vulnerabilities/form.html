{% extends "base.html" %}

{% block title %}{{ 'Редактирование уязвимости' if vulnerability else 'Создание уязвимости' }} - Программное средство для оценки рисков ИБ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>{{ 'Редактирование уязвимости' if vulnerability else 'Создание уязвимости' }}</h2>
        
        <form method="POST" id="vulnerability-form">
            <div class="form-section">
                <div class="mb-3">
                    <label for="id" class="form-label">Идентификатор <small class="text-muted">(необязательно, будет сгенерирован автоматически)</small></label>
                    <input type="text" class="form-control" id="id" name="id" value="{{ vulnerability.id if vulnerability else '' }}" placeholder="Оставьте пустым для автогенерации">
                </div>
                
                <div class="mb-3">
                    <label for="name" class="form-label">Наименование уязвимости</label>
                    <input type="text" class="form-control" id="name" name="name" value="{{ vulnerability.name if vulnerability else '' }}" required>
                </div>
                
                <div class="mb-3">
                    <label for="description" class="form-label">Описание уязвимости</label>
                    <textarea class="form-control" id="description" name="description" rows="4">{{ vulnerability.description if vulnerability else '' }}</textarea>
                </div>
            
            <button type="submit" class="btn btn-primary">{{ 'Сохранить изменения' if vulnerability else 'Создать уязвимость' }}</button>
            <a href="{{ url_for('vulnerabilities_list') }}" class="btn btn-secondary">Отмена</a>
        </form>
    </div>
</div>

<script>
document.getElementById('vulnerability-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = {
        id: document.getElementById('id').value,
        name: document.getElementById('name').value,
        description: document.getElementById('description').value
    };
    
    const vulnerabilityId = "{{ vulnerability.id if vulnerability else '' }}";
    let requestUrl, method;
    
    if (vulnerabilityId) {
        // Редактирование
        requestUrl = `/api/vulnerabilities/${vulnerabilityId}`;
        method = 'PUT';
    } else {
        // Создание
        requestUrl = '/api/vulnerabilities';
        method = 'POST';
    }
    
    fetch(requestUrl, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        } else {
            throw new Error('Ошибка при сохранении');
        }
    })
    .then(data => {
        showNotification('Уязвимость успешно сохранена', 'success');
        window.location.href = "{{ url_for('vulnerabilities_list') }}";
    })
    .catch(error => {
        showNotification('Ошибка при сохранении уязвимости', 'danger');
        console.error('Error:', error);
    });
});
</script>
{% endblock %}