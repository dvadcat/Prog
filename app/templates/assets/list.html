{% extends "base.html" %}

{% block title %}Формирование перечня активов - Программное средство для оценки рисков ИБ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>Формирование перечня активов и определение их ценности</h2>
        <p class="text-muted">Формирование базы данных защищаемых активов объекта</p>
        
        <!-- Шкала стоимости актива (общая для всех активов) -->
        <div class="mb-4" id="asset-cost-scale-section">
            <h4>Шкала стоимости актива</h4>
            <p class="text-muted">Заполните шкалу стоимости актива для объекта:</p>
            <table class="table table-bordered w-100">
                <thead>
                    <tr>
                        <th>Качественная шкала</th>
                        <th>Минимальная стоимость</th>
                        <th>Средняя стоимость</th>
                        <th>Высокая стоимость</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Количественная шкала</td>
                        <td><input type="text" class="form-control" id="asset_cost_scale_low" placeholder=""></td>
                        <td><input type="text" class="form-control" id="asset_cost_scale_medium" placeholder=""></td>
                        <td><input type="text" class="form-control" id="asset_cost_scale_high" placeholder=""></td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="btn btn-sm btn-success" id="save-cost-scale-btn">Сохранить шкалу</button>
        </div>
        
        <h4>Защищаемые активы</h4>
        
        <div class="mb-3">
            <a href="{{ url_for('create_asset') }}" class="btn btn-primary me-2">Создать актив</a>
            <a href="/api/assets/dependencies" class="btn btn-info me-2">Зависимости активов</a>
        </div>
        
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Область</th>
                        <th>Наименование</th>
                        <th>Тип</th>
                        <th>Свойства ИБ</th>
                        <th>Ценность без зависимостей</th>
                        <th>Ценность с зависимостями</th>
                        <th>Стоимость</th>
                        <th>Дата создания</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody id="assets-table-body">
                    <!-- Данные будут загружаться через JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Загрузка шкалы стоимости актива из первого контекста (или можно сделать глобальную настройку)
    loadAssetCostScale();
    
   // Загрузка списка активов
   fetchData('/api/assets')
       .then(data => {
           if (data) {
               const tbody = document.getElementById('assets-table-body');
               tbody.innerHTML = '';
               
               data.forEach(asset => {
                   // Парсим свойства ИБ
                   let propertiesText = '';
                   if (asset.properties) {
                       try {
                           const props = JSON.parse(asset.properties);
                           const propsList = [];
                           if (props.confidentiality) propsList.push('К');
                           if (props.integrity) propsList.push('Ц');
                           if (props.availability) propsList.push('Д');
                           propertiesText = propsList.join(',');
                       } catch (e) {
                           propertiesText = 'Ошибка';
                       }
                   }
                   
                   // Словарь для перевода типов активов
                   const typeTranslations = {
                       'information': 'Информационный',
                       'software': 'Программный',
                       'hardware': 'Аппаратный',
                       'personnel': 'Персонал',
                       'facility': 'Объект недвижимости',
                       'network': 'Сетевой',
                       'data': 'Данные',
                       'service': 'Услуга'
                   };
                   
                   const translatedType = typeTranslations[asset.type] || asset.type;
                   
                   const row = document.createElement('tr');
                   row.innerHTML = `
                       <td>${asset.id}</td>
                       <td>${asset.context ? asset.context.name : ''}</td>
                       <td>${asset.name}</td>
                       <td>${translatedType}</td>
                       <td>${propertiesText}</td>
                       <td>${asset.value_without_dependencies || '-'}</td>
                       <td>${asset.dependency_value || '-'}</td>
                       <td>${asset.asset_cost ? asset.asset_cost + ' тыс.руб.' : '-'}</td>
                       <td>${new Date(asset.created_at).toLocaleDateString()}</td>
                       <td>
                           <a href="/assets/${asset.id}/edit" class="btn btn-sm btn-outline-primary me-1">Изменить</a>
                           <button class="btn btn-sm btn-outline-danger" onclick="deleteAsset(${asset.id})">Удалить</button>
                       </td>
                   `;
                   tbody.appendChild(row);
               });
           }
       });
});

function deleteAsset(id) {
    confirmDelete('Вы уверены, что хотите удалить этот актив?', () => {
        fetch(`/api/assets/${id}`, { method: 'DELETE' })
            .then(response => {
                if (response.ok) {
                    showNotification('Актив успешно удален', 'success');
                    location.reload();
                } else {
                    showNotification('Ошибка при удалении актива', 'danger');
                }
            });
    });
}

// Удаляем временную функцию url_for, так как Jinja2 уже сгенерировал правильные URL
// Все ссылки в таблице уже содержат правильные URL, сгенерированные на сервере

// Глобальная переменная для хранения ID контекста
let currentContextId = null;

// Загрузка шкалы стоимости актива
function loadAssetCostScale() {
    fetch('/api/contexts')
        .then(response => response.json())
        .then(contexts => {
            if (contexts && contexts.length > 0) {
                currentContextId = contexts[0].id;
                const context = contexts[0];
                if (context.asset_cost_scale) {
                    try {
                        const costScale = JSON.parse(context.asset_cost_scale);
                        document.getElementById('asset_cost_scale_low').value = costScale.low_value || '';
                        document.getElementById('asset_cost_scale_medium').value = costScale.medium_value || '';
                        document.getElementById('asset_cost_scale_high').value = costScale.high_value || '';
                    } catch (e) {
                        console.error('Ошибка при загрузке шкалы стоимости:', e);
                    }
                }
            } else {
                document.getElementById('asset-cost-scale-section').innerHTML = 
                    '<div class="alert alert-warning">Сначала создайте область для сохранения шкалы стоимости.</div>';
            }
        })
        .catch(error => {
            console.error('Ошибка загрузки контекстов:', error);
        });
}

// Сохранение шкалы стоимости актива
document.getElementById('save-cost-scale-btn').addEventListener('click', function() {
    if (!currentContextId) {
        showNotification('Сначала создайте область', 'warning');
        return;
    }
    
    const costScale = {
        low_value: document.getElementById('asset_cost_scale_low').value,
        medium_value: document.getElementById('asset_cost_scale_medium').value,
        high_value: document.getElementById('asset_cost_scale_high').value
    };
    
    fetch(`/api/contexts/${currentContextId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            asset_cost_scale: JSON.stringify(costScale)
        })
    })
    .then(response => {
        if (response.ok) {
            showNotification('Шкала стоимости сохранена', 'success');
        } else {
            return response.text().then(text => {
                console.error('Ответ сервера:', text);
                showNotification('Ошибка при сохранении шкалы', 'danger');
            });
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        showNotification('Ошибка при сохранении шкалы', 'danger');
    });
});
</script>
{% endblock %}