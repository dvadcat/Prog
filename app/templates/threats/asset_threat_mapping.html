{% extends "base.html" %}

{% block title %}Соответствие между активами и угрозами - Программное средство для оценки рисков ИБ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>Соответствие между активами и угрозами</h2>
        
        <form method="POST" id="asset-threat-mapping-form">
            <div class="mb-3">
                <label for="selected_threat" class="form-label">Выберите угрозу</label>
                <select class="form-control" id="selected_threat" name="selected_threat" required>
                    <option value="">Выберите угрозу...</option>
                    {% for threat in threats %}
                    <option value="{{ threat.id }}" data-name="{{ threat.name }}">
                        {{ threat.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </form>
    </div>
</div>

<div class="row mt-4" id="mapping-table" style="display: none;">
    <div class="col-12">
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Угроза ИБ</th>
                    <th>Информационные активы</th>
                    <th>Аппаратные средства</th>
                    <th>Программные средства</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td id="threat-name">-</td>
                    <td>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="info_assets_conf" name="info_assets_conf">
                            <label class="form-check-label" for="info_assets_conf">К (Конфиденциальность)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="info_assets_int" name="info_assets_int">
                            <label class="form-check-label" for="info_assets_int">Д (Доступность)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="info_assets_av" name="info_assets_av">
                            <label class="form-check-label" for="info_assets_av">Ц (Целостность)</label>
                        </div>
                    </td>
                    <td>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="hardware_conf" name="hardware_conf">
                            <label class="form-check-label" for="hardware_conf">К (Конфиденциальность)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="hardware_int" name="hardware_int">
                            <label class="form-check-label" for="hardware_int">Д (Доступность)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="hardware_av" name="hardware_av">
                            <label class="form-check-label" for="hardware_av">Ц (Целостность)</label>
                        </div>
                    </td>
                    <td>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="software_conf" name="software_conf">
                            <label class="form-check-label" for="software_conf">К (Конфиденциальность)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="software_int" name="software_int">
                            <label class="form-check-label" for="software_int">Д (Доступность)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="software_av" name="software_av">
                            <label class="form-check-label" for="software_av">Ц (Целостность)</label>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
document.getElementById('selected_threat').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    if (selectedOption.value) {
        // Показываем таблицу
        document.getElementById('mapping-table').style.display = 'block';
        
        // Заполняем название угрозы
        document.getElementById('threat-name').textContent = selectedOption.dataset.name;
        
        // Автоматически устанавливаем чекбоксы на основе данных угрозы
        fetch(`/api/threats/${selectedOption.value}`)
            .then(response => response.json())
            .then(threat => {
                // Устанавливаем чекбоксы для информационных активов
                document.getElementById('info_assets_conf').checked = threat.confidentiality_violation;
                document.getElementById('info_assets_int').checked = threat.integrity_violation;
                document.getElementById('info_assets_av').checked = threat.availability_violation;
                
                // Устанавливаем чекбоксы для аппаратных средств (такие же как у информационных)
                document.getElementById('hardware_conf').checked = threat.confidentiality_violation;
                document.getElementById('hardware_int').checked = threat.integrity_violation;
                document.getElementById('hardware_av').checked = threat.availability_violation;
                
                // Устанавливаем чекбоксы для программных средств (такие же как у информационных)
                document.getElementById('software_conf').checked = threat.confidentiality_violation;
                document.getElementById('software_int').checked = threat.integrity_violation;
                document.getElementById('software_av').checked = threat.availability_violation;
            })
            .catch(error => console.error('Ошибка загрузки данных угрозы:', error));
    } else {
        // Скрываем таблицу
        document.getElementById('mapping-table').style.display = 'none';
    }
});
</script>
{% endblock %}