{% extends "base.html" %}

{% block title %}Оценка вероятности реализации угрозы для каждого актива - Программное средство для оценки рисков ИБ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>Оценка вероятности реализации угрозы для каждого актива</h2>
        
        <form method="POST" id="asset-probability-form">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="selected_asset" class="form-label">Выберите актив</label>
                        <select class="form-control" id="selected_asset" name="selected_asset" required>
                            <option value="">Выберите актив...</option>
                            <!-- Активы будут загружены через JavaScript -->
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="selected_threat" class="form-label">Выберите угрозу</label>
                        <select class="form-control" id="selected_threat" name="selected_threat" required>
                            <option value="">Выберите угрозу...</option>
                            {% for threat in threats %}
                            <option value="{{ threat.id }}" data-name="{{ threat.name }}">
                                {{ threat.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="row mt-4" id="evaluation-table" style="display: none;">
    <div class="col-12">
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Актив</th>
                    <th>Угроза</th>
                    <th>Оценка вероятности реализации</th>
                </tr>
            </thead>
            <tbody>
                <tr id="evaluation-row" style="display: none;">
                    <td id="asset-name">-</td>
                    <td id="threat-name">-</td>
                    <td>
                        <div class="input-group">
                            <input type="number" class="form-control" id="probability-value" name="probability_value" step="0.0001" min="0" max="1" placeholder="0.000">
                            <button class="btn btn-outline-secondary" type="button" onclick="determineQualitativeValue()">Определить</button>
                        </div>
                        <div class="mt-2">
                            <select class="form-control" id="qualitative-value" name="qualitative_value">
                                <option value="">Выберите качественное значение</option>
                                <option value="минимальная">Минимальная [0.25; 0.4]</option>
                                <option value="средняя">Средняя [0.4; 0.7]</option>
                                <option value="высокая">Высокая [0.7; 1.0]</option>
                            </select>
                        </div>
                        <div id="result-info" class="mt-2" style="display: none;">
                            <p id="result-text"></p>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
// Загрузка активов
fetch('/api/assets/')
    .then(response => response.json())
    .then(assets => {
        const assetSelect = document.getElementById('selected_asset');
        
        // Очищаем селект
        assetSelect.innerHTML = '<option value="">Выберите актив...</option>';
        
        // Добавляем активы в селект
        assets.forEach(asset => {
            const option = document.createElement('option');
            option.value = asset.id;
            option.textContent = asset.name;
            option.dataset.name = asset.name;
            assetSelect.appendChild(option);
        });
    })
    .catch(error => console.error('Ошибка загрузки активов:', error));

// Обработчик изменения выбранного актива или угрозы
document.getElementById('selected_asset').addEventListener('change', updateTable);
document.getElementById('selected_threat').addEventListener('change', updateTable);

function updateTable() {
    const assetSelect = document.getElementById('selected_asset');
    const threatSelect = document.getElementById('selected_threat');
    
    if (assetSelect.value && threatSelect.value) {
        // Показываем строку с оценкой
        document.getElementById('evaluation-row').style.display = 'table-row';
        
        // Заполняем названия актива и угрозы
        const selectedAssetOption = assetSelect.options[assetSelect.selectedIndex];
        const selectedThreatOption = threatSelect.options[threatSelect.selectedIndex];
        
        document.getElementById('asset-name').textContent = selectedAssetOption.dataset.name;
        document.getElementById('threat-name').textContent = selectedThreatOption.dataset.name;
        
        // Сбрасываем значения
        document.getElementById('probability-value').value = '';
        document.getElementById('qualitative-value').value = '';
        document.getElementById('result-info').style.display = 'none';
    } else {
        // Скрываем строку с оценкой
        document.getElementById('evaluation-row').style.display = 'none';
    }
}

function determineQualitativeValue() {
    const probabilityValue = document.getElementById('probability-value').value;
    if (!probabilityValue) {
        alert('Пожалуйста, введите числовое значение вероятности');
        return;
    }
    
    const probability = parseFloat(probabilityValue);
    let qualitativeValue = '';
    
    if (probability >= 0.25 && probability <= 0.4) {
        qualitativeValue = 'Минимальная';
    } else if (probability > 0.4 && probability <= 0.7) {
        qualitativeValue = 'Средняя';
    } else if (probability > 0.7 && probability <= 1.0) {
        qualitativeValue = 'Высокая';
    } else {
        qualitativeValue = 'Значение вне диапазона [0.25; 1.0]';
    }
    
    document.getElementById('result-text').innerHTML = `
        <strong>Числовое значение:</strong> ${probability.toFixed(4)}<br>
        <strong>Качественное значение:</strong> ${qualitativeValue}
    `;
    document.getElementById('result-info').style.display = 'block';
}

// Обработчик изменения качественного значения
document.getElementById('qualitative-value').addEventListener('change', function() {
    if (this.value) {
        // Автоматически устанавливаем числовое значение в зависимости от диапазона
        switch(this.value) {
            case 'минимальная':
                document.getElementById('probability-value').value = '0.3000';
                break;
            case 'средняя':
                document.getElementById('probability-value').value = '0.5500';
                break;
            case 'высокая':
                document.getElementById('probability-value').value = '0.8500';
                break;
        }
    }
});
</script>
{% endblock %}