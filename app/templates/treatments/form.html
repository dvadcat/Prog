{% extends "base.html" %}

{% block title %}{{ 'Редактирование плана обработки' if treatment else 'Создание плана обработки' }} - Программное средство для оценки рисков ИБ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>{{ 'Редактирование плана обработки' if treatment else 'Создание плана обработки' }}</h2>
        
        <form method="POST" id="treatment-form">
            <div class="form-section">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="incident_id" class="form-label">Инцидент</label>
                            <select class="form-control" id="incident_id" name="incident_id" required>
                                <option value="">Выберите инцидент</option>
                                <!-- Инциденты будут загружены через JavaScript -->
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="residual_risk" class="form-label">Остаточный риск</label>
                            <select class="form-control" id="residual_risk" name="residual_risk">
                                <option value="" {% if not treatment or not treatment.residual_risk %}selected{% endif %}>Не оценено</option>
                                <option value="низкий" {% if treatment and treatment.residual_risk == 'низкий' %}selected{% endif %}>Низкий</option>
                                <option value="средний" {% if treatment and treatment.residual_risk == 'средний' %}selected{% endif %}>Средний</option>
                                <option value="высокий" {% if treatment and treatment.residual_risk == 'высокий' %}selected{% endif %}>Высокий</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="resources" class="form-label">Необходимые ресурсы</label>
                            <textarea class="form-control" id="resources" name="resources" rows="2">{{ treatment.resources if treatment else '' }}</textarea>
                        </div>
                    
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="risk_treatment_measures" class="form-label">Меры по обработке риска</label>
                            <textarea class="form-control" id="risk_treatment_measures" name="risk_treatment_measures" rows="3" required>{{ treatment.risk_treatment_measures if treatment else '' }}</textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="deadlines" class="form-label">Сроки</label>
                            <textarea class="form-control" id="deadlines" name="deadlines" rows="2">{{ treatment.deadlines if treatment else '' }}</textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="responsible_persons" class="form-label">Ответственные лица</label>
                            <textarea class="form-control" id="responsible_persons" name="responsible_persons" rows="2">{{ treatment.responsible_persons if treatment else '' }}</textarea>
                        </div>
                    </div>
                
                <div class="mb-3">
                    <label for="actions" class="form-label">Предпринятые действия/статус выполнения</label>
                    <textarea class="form-control" id="actions" name="actions" rows="3">{{ treatment.actions if treatment else '' }}</textarea>
                </div>
            
            <button type="submit" class="btn btn-primary">{{ 'Сохранить изменения' if treatment else 'Создать план' }}</button>
            <a href="{{ url_for('treatments_list') }}" class="btn btn-secondary">Отмена</a>
        </form>
    </div>
</div>

<script>
// Загрузка инцидентов
fetch('/api/incidents')
    .then(response => response.json())
    .then(data => {
        const incidentSelect = document.getElementById('incident_id');
        data.forEach(incident => {
            const option = document.createElement('option');
            option.value = incident.id;
            option.textContent = `Инцидент #${incident.id}: ${incident.scenario_name || 'Без названия'}`;
            if ({{ treatment.incident_id if treatment else 0 }} === incident.id) {
                option.selected = true;
            }
            incidentSelect.appendChild(option);
        });
    });

document.getElementById('treatment-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = {
        incident_id: parseInt(document.getElementById('incident_id').value),
        risk_treatment_measures: document.getElementById('risk_treatment_measures').value,
        residual_risk: document.getElementById('residual_risk').value,
        resources: document.getElementById('resources').value,
        deadlines: document.getElementById('deadlines').value,
        responsible_persons: document.getElementById('responsible_persons').value,
        actions: document.getElementById('actions').value
    };
    
    const treatmentId = {{ treatment.id if treatment else 'null' }};
    let requestUrl, method;
    
    if (treatmentId) {
        // Редактирование
        requestUrl = `/api/treatment_plans/${treatmentId}`;
        method = 'PUT';
    } else {
        // Создание
        requestUrl = '/api/treatment_plans';
        method = 'POST';
    }
    
    fetch(requestUrl, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        } else {
            throw new Error('Ошибка при сохранении');
        }
    })
    .then(data => {
        showNotification('План обработки риска успешно сохранен', 'success');
        window.location.href = "{{ url_for('treatments_list') }}";
    })
    .catch(error => {
        showNotification('Ошибка при сохранении плана обработки', 'danger');
        console.error('Error:', error);
    });
});
</script>
{% endblock %}