{% extends "base.html" %}

{% block title %}{{ 'Редактирование области' if context else 'Определение области' }} - Программное средство для оценки рисков ИБ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>{{ 'Редактирование области управления рисками' if context else 'Определение области управления рисками и критериев риска' }}</h2>
        
        <form method="POST" id="context-form" data-context-id="{{ context.id if context else '' }}" data-selected-impact-criteria="{{ context.selected_impact_criteria if context and context.selected_impact_criteria else 'null' }}" data-risk-evaluation-criteria="{{ context.risk_evaluation_criteria if context and context.risk_evaluation_criteria else 'null' }}" data-damage-scales="{{ context.damage_scales if context and context.damage_scales else 'null' }}" data-risk-acceptance-criteria="{{ context.risk_acceptance_criteria if context and context.risk_acceptance_criteria else 'null' }}">
            <div class="form-section">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="name" class="form-label">Название объекта</label>
                            <input type="text" class="form-control" id="name" name="name" value="{{ context.name if context else '' }}" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="owner_name" class="form-label">ФИО ответственного</label>
                            <input type="text" class="form-control" id="owner_name" name="owner_name" value="{{ context.owner_name if context else '' }}">
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="description" class="form-label">Описание объекта</label>
                            <textarea class="form-control" id="description" name="description" rows="4">{{ context.description if context else '' }}</textarea>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <h4>Критерии влияния риска</h4>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="criterion1" name="impact_criteria" value="нарушение законодательных требований">
                        <label class="form-check-label fs-6" for="criterion1">Нарушение законодательных требований</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="criterion2" name="impact_criteria" value="нарушение договорных обязательств">
                        <label class="form-check-label fs-6" for="criterion2">Нарушение договорных обязательств</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="criterion3" name="impact_criteria" value="нарушение функционирования бизнес-процессов">
                        <label class="form-check-label fs-6" for="criterion3">Нарушение функционирования бизнес-процессов</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="criterion4" name="impact_criteria" value="создание угрозы для безопасности внутренней и внешней среды">
                        <label class="form-check-label fs-6" for="criterion4">Создание угрозы для безопасности внутренней и внешней среды</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="criterion5" name="impact_criteria" value="опасность для персонала и сотрудников объекта">
                        <label class="form-check-label fs-6" for="criterion5">Опасность для персонала и сотрудников объекта</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="criterion6" name="impact_criteria" value="финансовые потери">
                        <label class="form-check-label fs-6" for="criterion6">Финансовые потери</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="criterion7" name="impact_criteria" value="материальный ущерб">
                        <label class="form-check-label fs-6" for="criterion7">Материальный ущерб</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="criterion8" name="impact_criteria" value="негативные последствия для репутации">
                        <label class="form-check-label fs-6" for="criterion8">Негативные последствия для репутации ("неосязаемого капитала")</label>
                    </div>
                </div>
                
                <!-- Шкалы ущерба для выбранных критериев (перемещено выше) -->
                <div class="mb-4">
                    <h4>Шкалы ущерба для критериев влияния</h4>
                    <p class="text-muted">Для каждого выбранного критерия влияния определите шкалу ущерба:</p>
                    <div id="damage-scales-container">
                        <!-- Динамические шкалы будут добавляться сюда -->
                    </div>
                </div>
                
                <!-- Критерии оценивания рисков ИБ объекта -->
                <div class="mb-4">
                    <h4>Критерии оценивания рисков ИБ объекта</h4>
                    <p class="text-muted">Заполните таблицу критериев оценивания рисков ИБ для объекта:</p>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Качественный критерий оценивания риска</th>
                                <th>Низкий уровень риска</th>
                                <th>Средний уровень риска</th>
                                <th>Высокий уровень риска</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Количественный критерий оценивания риска</td>
                                <td><input type="text" class="form-control form-control-sm" name="risk_criteria_low" placeholder="например, До 40,0 тыс. руб."></td>
                                <td><input type="text" class="form-control form-control-sm" name="risk_criteria_medium" placeholder="например, От 40,0 до 200,0 тыс. руб."></td>
                                <td><input type="text" class="form-control form-control-sm" name="risk_criteria_high" placeholder="например, От 200,0 до 900,0 тыс. руб."></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Критерии принятия риска -->
                <div class="mb-4">
                    <h4>Критерии принятия риска</h4>
                    <p class="text-muted">Определите, какой уровень риска является приемлемым или неприемлемым для объекта:</p>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Уровень риска</th>
                                <th>Приемлемость для объекта</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Низкий уровень риска</td>
                                <td>
                                    <select class="form-select form-select-sm" name="risk_acceptance_low">
                                        <option value="приемлемый">Приемлемый</option>
                                        <option value="неприемлемый">Неприемлемый</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td>Средний уровень риска</td>
                                <td>
                                    <select class="form-select form-select-sm" name="risk_acceptance_medium">
                                        <option value="приемлемый">Приемлемый</option>
                                        <option value="неприемлемый">Неприемлемый</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td>Высокий уровень риска</td>
                                <td>
                                    <select class="form-select form-select-sm" name="risk_acceptance_high">
                                        <option value="приемлемый">Приемлемый</option>
                                        <option value="неприемлемый" selected>Неприемлемый</option>
                                    </select>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary">{{ 'Сохранить изменения' if context else 'Создать' }}</button>
            <a href="{{ url_for('contexts_list') }}" class="btn btn-secondary">Отмена</a>
        </form>
    </div>
</div>

<script>
// Функция для обновления шкал ущерба при изменении чекбоксов
function updateDamageScales() {
    const scalesContainer = document.getElementById('damage-scales-container');
    scalesContainer.innerHTML = '';
    
    const selectedCheckboxes = document.querySelectorAll('input[name="impact_criteria"]:checked');
    
    selectedCheckboxes.forEach((checkbox, index) => {
        const criterion = checkbox.value;
        const scaleDiv = document.createElement('div');
        scaleDiv.className = 'mb-3';
        scaleDiv.innerHTML = `
            <h6>Шкала ущерба для: ${criterion}</h6>
            <table class="table table-bordered table-sm">
                <thead>
                    <tr>
                        <th>Величина ущерба</th>
                        <th>Определение ущерба</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Минимальная</td>
                        <td><input type="text" class="form-control form-control-sm damage-scale-input" data-criterion="${criterion}" data-level="minimal" placeholder="Определение минимального ущерба"></td>
                    </tr>
                    <tr>
                        <td>Средняя</td>
                        <td><input type="text" class="form-control form-control-sm damage-scale-input" data-criterion="${criterion}" data-level="medium" placeholder="Определение среднего ущерба"></td>
                    </tr>
                    <tr>
                        <td>Высокая</td>
                        <td><input type="text" class="form-control form-control-sm damage-scale-input" data-criterion="${criterion}" data-level="high" placeholder="Определение высокого ущерба"></td>
                    </tr>
                </tbody>
            </table>
        `;
        scalesContainer.appendChild(scaleDiv);
    });
}

document.querySelectorAll('input[name="impact_criteria"]').forEach(checkbox => {
    checkbox.addEventListener('change', updateDamageScales);
});

document.addEventListener('DOMContentLoaded', function() {
    updateDamageScales();
    
    const form = document.getElementById('context-form');
    const savedCriteriaStr = form.getAttribute('data-selected-impact-criteria');
    if (savedCriteriaStr && savedCriteriaStr !== 'null') {
        try {
            const savedCriteria = JSON.parse(savedCriteriaStr);
            if (savedCriteria && Array.isArray(savedCriteria)) {
                savedCriteria.forEach(criterion => {
                    const checkbox = document.querySelector(`input[name="impact_criteria"][value="${criterion}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
                updateDamageScales();
            }
        } catch (e) {
            console.error('Ошибка при загрузке сохраненных критериев:', e);
        }
    }
    
    const riskEvaluationCriteriaStr = form.getAttribute('data-risk-evaluation-criteria');
    if (riskEvaluationCriteriaStr && riskEvaluationCriteriaStr !== 'null') {
        try {
            const riskCriteria = JSON.parse(riskEvaluationCriteriaStr);
            if (riskCriteria) {
                document.querySelector('input[name="risk_criteria_low"]').value = riskCriteria.low || '';
                document.querySelector('input[name="risk_criteria_medium"]').value = riskCriteria.medium || '';
                document.querySelector('input[name="risk_criteria_high"]').value = riskCriteria.high || '';
            }
        } catch (e) {
            console.error('Ошибка при загрузке критериев оценивания рисков:', e);
        }
    }
    
    const damageScalesStr = form.getAttribute('data-damage-scales');
    if (damageScalesStr && damageScalesStr !== 'null') {
        try {
            const damageScales = JSON.parse(damageScalesStr);
            setTimeout(() => {
                Object.keys(damageScales).forEach((criterion) => {
                    const minimalInput = document.querySelector(`input[data-criterion="${criterion}"][data-level="minimal"]`);
                    const mediumInput = document.querySelector(`input[data-criterion="${criterion}"][data-level="medium"]`);
                    const highInput = document.querySelector(`input[data-criterion="${criterion}"][data-level="high"]`);
                    
                    if (minimalInput && damageScales[criterion].minimal) {
                        minimalInput.value = damageScales[criterion].minimal;
                    }
                    if (mediumInput && damageScales[criterion].medium) {
                        mediumInput.value = damageScales[criterion].medium;
                    }
                    if (highInput && damageScales[criterion].high) {
                        highInput.value = damageScales[criterion].high;
                    }
                });
            }, 100);
        } catch (e) {
            console.error('Ошибка при загрузке шкал ущерба:', e);
        }
    }
    
    const riskAcceptanceCriteriaStr = form.getAttribute('data-risk-acceptance-criteria');
    if (riskAcceptanceCriteriaStr && riskAcceptanceCriteriaStr !== 'null') {
        try {
            const riskAcceptance = JSON.parse(riskAcceptanceCriteriaStr);
            if (riskAcceptance) {
                if (riskAcceptance.low) {
                    document.querySelector('select[name="risk_acceptance_low"]').value = riskAcceptance.low;
                }
                if (riskAcceptance.medium) {
                    document.querySelector('select[name="risk_acceptance_medium"]').value = riskAcceptance.medium;
                }
                if (riskAcceptance.high) {
                    document.querySelector('select[name="risk_acceptance_high"]').value = riskAcceptance.high;
                }
            }
        } catch (e) {
            console.error('Ошибка при загрузке критериев принятия риска:', e);
        }
    }
});

document.getElementById('context-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const impactCriteriaCheckboxes = document.querySelectorAll('input[name="impact_criteria"]:checked');
    const selectedImpactCriteria = Array.from(impactCriteriaCheckboxes).map(cb => cb.value);
    
    const damageScales = {};
    const selectedCheckboxes = document.querySelectorAll('input[name="impact_criteria"]:checked');
    selectedCheckboxes.forEach((checkbox) => {
        const criterion = checkbox.value;
        damageScales[criterion] = {
            minimal: document.querySelector(`input[data-criterion="${criterion}"][data-level="minimal"]`)?.value || '',
            medium: document.querySelector(`input[data-criterion="${criterion}"][data-level="medium"]`)?.value || '',
            high: document.querySelector(`input[data-criterion="${criterion}"][data-level="high"]`)?.value || ''
        };
    });
    
    const formData = {
        name: document.getElementById('name').value,
        owner_name: document.getElementById('owner_name').value,
        description: document.getElementById('description').value,
        risk_evaluation_criteria: JSON.stringify({
            low: document.querySelector('input[name="risk_criteria_low"]').value,
            medium: document.querySelector('input[name="risk_criteria_medium"]').value,
            high: document.querySelector('input[name="risk_criteria_high"]').value
        }),
        selected_impact_criteria: JSON.stringify(selectedImpactCriteria),
        damage_scales: JSON.stringify(damageScales),
        risk_acceptance_criteria: JSON.stringify({
            low: document.querySelector('select[name="risk_acceptance_low"]').value,
            medium: document.querySelector('select[name="risk_acceptance_medium"]').value,
            high: document.querySelector('select[name="risk_acceptance_high"]').value
        })
    };
    
    const form = document.getElementById('context-form');
    const contextId = form.getAttribute('data-context-id');
    let requestUrl, method;
    
    if (contextId) {
        requestUrl = `/api/contexts/${contextId}`;
        method = 'PUT';
    } else {
        requestUrl = '/api/contexts';
        method = 'POST';
    }
    
    fetch(requestUrl, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        } else {
            throw new Error('Ошибка при сохранении');
        }
    })
    .then(data => {
        showNotification('Область успешно сохранена', 'success');
        window.location.href = "{{ url_for('contexts_list') }}";
    })
    .catch(error => {
        showNotification('Ошибка при сохранении области', 'danger');
        console.error('Error:', error);
    });
});
</script>
{% endblock %}
