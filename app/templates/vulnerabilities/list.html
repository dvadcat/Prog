{% extends "base.html" %}

{% block title %}Идентификация уязвимостей - Программное средство для оценки рисков ИБ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>Идентификация уязвимостей и их уровни</h2>
        <p class="text-muted">Формирование базы данных уязвимостей защищаемых активов</p>

        <div class="mb-3">
            <a href="{{ url_for('create_vulnerability') }}" class="btn btn-primary me-2">Создать уязвимость</a>
            <a href="/vulnerabilities/identify" class="btn btn-info me-2">Идентифицировать уязвимости активов</a>

        </div>

        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Наименование</th>
                        <th>Описание</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody id="vulnerabilities-table-body">
                    <!-- Данные будут загружаться через JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Загрузка списка уязвимостей
    fetchData('/api/vulnerabilities')
        .then(data => {
            if (data) {
                const tbody = document.getElementById('vulnerabilities-table-body');
                tbody.innerHTML = '';

                data.forEach(vulnerability => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${vulnerability.id}</td>
                        <td>${vulnerability.name}</td>
                        <td>${vulnerability.description || ''}</td>
                        <td>
                            <a href="/vulnerabilities/${vulnerability.id}/edit" class="btn btn-sm btn-outline-primary">Изменить</a>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteVulnerability('${vulnerability.id}')">Удалить</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
        });
});

function deleteVulnerability(id) {
    confirmDelete('Вы уверены, что хотите удалить эту уязвимость?', () => {
        fetch(`/api/vulnerabilities/${id}`, { method: 'DELETE' })
            .then(response => {
                if (response.ok) {
                    showNotification('Уязвимость успешно удалена', 'success');
                    location.reload();
                } else {
                    showNotification('Ошибка при удалении уязвимости', 'danger');
                }
            });
    });
}

function url_for(endpoint, params) {
    // Временная функция для генерации URL
    if (endpoint === 'edit_vulnerability') {
        return `/vulnerabilities/${params.vulnerability_id}/edit`;
    }
    return '#';
}
</script>
{% endblock %}