{% extends "base.html" %}

{% block title %}Зависимости активов{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2>Зависимость активов</h2>
            <p><strong>12 - Зависимость активов:</strong></p>
            
            <div class="card mb-4">
                <div class="card-body">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Актив</th>
                                {% for asset in assets %}
                                <th>{{ asset.name }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for asset in assets %}
                            <tr>
                                <td>{{ asset.name }}</td>
                                {% for other_asset in assets %}
                                <td>
                                    <input type="checkbox" 
                                           class="dependency-checkbox" 
                                           data-asset-id="{{ asset.id }}" 
                                           data-depends-on-id="{{ other_asset.id }}"
                                           {% if asset.id == other_asset.id %}disabled{% endif %}>
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    
                    <button type="button" class="btn btn-success" onclick="saveDependencies()">Сохранить зависимости</button>
                </div>
            </div>
            
            <!-- Итоговая таблица ценности активов -->
            <h4>Итоговая ценность активов</h4>
            <div class="card">
                <div class="card-body">
                    <table class="table table-bordered table-striped">
                        <thead>
                            <tr>
                                <th>Актив</th>
                                <th>Ценность без зависимостей</th>
                                <th>Ценность с зависимостями</th>
                            </tr>
                        </thead>
                        <tbody id="asset-values-table-body">
                            {% for asset in assets %}
                            <tr>
                                <td>{{ asset.name }}</td>
                                <td>{{ asset.value_without_dependencies or '-' }}</td>
                                <td id="dep-value-{{ asset.id }}">{{ asset.dependency_value or '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function saveDependencies() {
    const checkboxes = document.querySelectorAll('.dependency-checkbox');
    const dependencies = [];
    
    checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
            const assetId = checkbox.getAttribute('data-asset-id');
            const dependsOnId = checkbox.getAttribute('data-depends-on-id');
            
            if (assetId && dependsOnId) {
                dependencies.push({
                    asset_id: parseInt(assetId),
                    depends_on_asset_id: parseInt(dependsOnId)
                });
            }
        }
    });
    
    fetch('/api/asset-dependencies/bulk-update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ dependencies: dependencies })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Зависимости активов сохранены и ценности пересчитаны!', 'success');
            // Перезагружаем страницу для обновления итоговой таблицы
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('Ошибка при сохранении зависимостей', 'danger');
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        showNotification('Ошибка при сохранении зависимостей', 'danger');
    });
}

// Загрузка существующих зависимостей при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    loadExistingDependencies();
});

function loadExistingDependencies() {
    fetch('/api/asset-dependencies/')
        .then(response => response.json())
        .then(data => {
            data.forEach(dep => {
                const checkbox = document.querySelector(`.dependency-checkbox[data-asset-id="${dep.asset_id}"][data-depends-on-id="${dep.depends_on_asset_id}"]`);
                if (checkbox) {
                    checkbox.checked = true;
                }
            });
        })
        .catch(error => {
            console.error('Ошибка загрузки зависимостей:', error);
        });
}
</script>
{% endblock %}