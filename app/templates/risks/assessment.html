{% extends "base.html" %}

{% block title %}Оценка рисков - Программное средство для оценки рисков ИБ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>Оценка рисков ИБ</h2>
        
        <div class="mb-3">
            <a href="{{ url_for('risks_list') }}" class="btn btn-secondary">Вернуться к списку рисков</a>
            <button class="btn btn-success" onclick="calculateAllRisks()">Рассчитать все риски</button>
        </div>

        <!-- Критерии оценки вероятности сценария инцидента -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Критерии оценки вероятности сценария инцидента</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th rowspan="1">Оценка вероятности реализации угрозы</th>
                                <th colspan="3">Низкая</th>
                                <th colspan="3">Средняя</th>
                                <th colspan="3">Высокая</th>
                            </tr>
                            <tr>
                                <th>Оценка уровня уязвимости</th><th>Н</th><th>С</th><th>В</th>
                                <th>Н</th><th>С</th><th>В</th>
                                <th>Н</th><th>С</th><th>В</th>
                            </tr>
                        </thead>
                        <tbody>
                            
                            <tr>
                                <td>Оценка вероятности сценария инцидента</td>
                                <td>1</td><td>2</td><td>3</td>
                                <td>2</td><td>3</td><td>4</td>
                                <td>3</td><td>4</td><td>5</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="mt-3">
                    <h6>Правило перевода числовых значений в качественные категории:</h6>
                    <ul>
                        <li>1–2 → «Низкая»</li>
                        <li>3–4 → «Средняя»</li>
                        <li>5 → «Высокая»</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Результаты оценки вероятности сценария инцидента -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Результаты оценки вероятности сценария инцидента</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Угроза</th>
                                <th>Уязвимости, используемые угрозой</th>
                                <th>Активы</th>
                                <th>Операционные последствия</th>
                                <th>Последствия для бизнеса</th>
                                <th>Оценка уровня последствий</th>
                                <th>Оценка вероятности сценария инцидента</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="scenario-results-table-body">
                            <!-- Данные будут загружаться через JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Критерии оценки уровня рисков -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Критерии оценки уровня рисков</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Уровень последствий ↓ \ Вероятность →</th>
                                <th>Низкая</th>
                                <th>Средняя</th>
                                <th>Высокая</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Оценка уровня последствий инцидента: Низкая</td>
                                <td>1</td>
                                <td>2</td>
                                <td>3</td>
                            </tr>
                            <tr>
                                <td>Оценка уровня последствий инцидента: Средняя</td>
                                <td>2</td>
                                <td>3</td>
                                <td>4</td>
                            </tr>
                            <tr>
                                <td>Оценка уровня последствий инцидента: Высокая</td>
                                <td>3</td>
                                <td>4</td>
                                <td>5</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="mt-3">
                    <h6>Интерпретация значений уровня риска:</h6>
                    <ul>
                        <li>1–2 — низкий уровень риска</li>
                        <li>3–4 — средний уровень риска</li>
                        <li>5 — высокий уровень риска</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Оценка уровня рисков -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Оценка уровня рисков</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Угроза</th>
                                <th>Уязвимости, используемые угрозой</th>
                                <th>Активы</th>
                                <th>Операционные последствия</th>
                                <th>Последствия для бизнеса</th>
                                <th>Оценка уровня последствий</th>
                                <th>Оценка вероятности сценария инцидента</th>
                                <th>Оценка уровня рисков</th>
                                <th>Приемлемый</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="risk-assessment-table-body">
                            <!-- Данные будут загружаться через JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let incidents = [];
let risks = [];
let riskAcceptanceCriteria = null; // Критерии принятия риска из контекста

// Загрузка данных при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    loadData();
});

function loadData() {
    // Загружаем инциденты, риски и критерии принятия риска из контекста
    Promise.all([
        fetch('/api/incidents').then(response => response.json()),
        fetch('/api/risks').then(response => response.json()),
        fetch('/api/contexts').then(response => response.json())
    ])
    .then(([incidentsData, risksData, contextsData]) => {
        incidents = incidentsData;
        risks = risksData;
        
        // Загружаем критерии принятия риска из первого контекста
        if (contextsData && contextsData.length > 0 && contextsData[0].risk_acceptance_criteria) {
            try {
                riskAcceptanceCriteria = JSON.parse(contextsData[0].risk_acceptance_criteria);
                console.log('Loaded risk acceptance criteria:', riskAcceptanceCriteria);
            } catch (e) {
                console.error('Ошибка парсинга критериев принятия риска:', e);
            }
        }
        
        renderScenarioResults();
        renderRiskAssessment();
    })
    .catch(error => {
        console.error('Ошибка загрузки данных:', error);
        showNotification('Ошибка загрузки данных', 'danger');
    });
}

function renderScenarioResults() {
    const tbody = document.getElementById('scenario-results-table-body');
    tbody.innerHTML = '';

    incidents.forEach(incident => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${escapeHtml(incident.threat ? incident.threat.name : 'Неизвестная угроза')}</td>
            <td>${escapeHtml(incident.vulnerability ? incident.vulnerability.name : 'Неизвестная уязвимость')}</td>
            <td>${escapeHtml(incident.asset ? incident.asset.name : 'Неизвестный актив')}</td>
            <td>${escapeHtml(incident.operational_impact || 'Не указано')}</td>
            <td>${escapeHtml(incident.business_impact || 'Не указано')}</td>
            <td>
                <select class="form-control form-control-sm" onchange="updateIncidentImpactLevel(${incident.id}, this.value)">
                    <option value="">Выберите...</option>
                    <option value="низкий" ${incident.impact_level === 'низкий' ? 'selected' : ''}>Низкий</option>
                    <option value="средний" ${incident.impact_level === 'средний' ? 'selected' : ''}>Средний</option>
                    <option value="высокий" ${incident.impact_level === 'высокий' ? 'selected' : ''}>Высокий</option>
                </select>
            </td>
            <td>
                <select class="form-control form-control-sm" onchange="updateScenarioProbability(${incident.id}, this.value)">
                    <option value="">Выберите...</option>
                    <option value="1" ${incident.scenario_probability === 1 ? 'selected' : ''}>1</option>
                    <option value="2" ${incident.scenario_probability === 2 ? 'selected' : ''}>2</option>
                    <option value="3" ${incident.scenario_probability === 3 ? 'selected' : ''}>3</option>
                    <option value="4" ${incident.scenario_probability === 4 ? 'selected' : ''}>4</option>
                    <option value="5" ${incident.scenario_probability === 5 ? 'selected' : ''}>5</option>
                </select>
            </td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="createOrUpdateRisk(${incident.id})">Создать/Обновить риск</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function renderRiskAssessment() {
    const tbody = document.getElementById('risk-assessment-table-body');
    tbody.innerHTML = '';

    // Отображаем все инциденты
    incidents.forEach(incident => {
        // Находим соответствующий риск, если он существует
        const risk = risks.find(r => r.incident_id === incident.id);
        
        // Используем данные из инцидента для расчета
        const impactLevel = incident.impact_level;
        const scenarioProbability = incident.scenario_probability;
        
        let riskScore, riskLevel, isAcceptable;
        
        // Если есть данные для расчета, рассчитываем автоматически
        if (impactLevel && scenarioProbability) {
            riskScore = calculateRiskScore(impactLevel, getLikelihoodText(scenarioProbability));
            riskLevel = getRiskLevel(riskScore);
            isAcceptable = isRiskAcceptable(riskScore);
        } else {
            // Если нет данных, используем значения из риска или по умолчанию
            riskScore = risk ? risk.risk_score : null;
            riskLevel = risk ? risk.risk_level : 'Не рассчитано';
            isAcceptable = riskScore ? isRiskAcceptable(riskScore) : false;
        }
        
        // Определяем уровень риска и приемлемость
        let finalRiskLevel = 'Не рассчитано';
        let finalIsAcceptable = false;
        let displayLikelihood = 'Не оценено';
        let calculatedRiskScore = null;
        
        // Получаем данные для отображения и расчета
        const displayImpactLevel = impactLevel || (risk ? risk.impact_level : null);
        const probabilityValue = scenarioProbability || (risk ? risk.scenario_probability : null);
        
        console.log('Incident data:', {impactLevel, scenarioProbability, displayImpactLevel, probabilityValue});
        
        if (probabilityValue) {
            displayLikelihood = getLikelihoodText(probabilityValue);
        }
        
        // Если есть данные для автоматического расчета по матрице - ВСЕГДА используем их
        if (displayImpactLevel && probabilityValue) {
            const likelihoodText = getLikelihoodText(probabilityValue);
            calculatedRiskScore = calculateRiskScore(displayImpactLevel, likelihoodText);
            finalRiskLevel = getRiskLevel(calculatedRiskScore);
            finalIsAcceptable = isRiskAcceptable(calculatedRiskScore);
            console.log('Calculated risk:', {displayImpactLevel, likelihoodText, calculatedRiskScore, finalRiskLevel});
        } else if (risk && risk.risk_level) {
            // Используем данные из существующего риска только если нет данных из инцидента
            finalRiskLevel = risk.risk_level;
            finalIsAcceptable = risk.risk_score ? isRiskAcceptable(risk.risk_score) : false;
        }
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${escapeHtml(incident.threat ? incident.threat.name : 'Неизвестная угроза')}</td>
            <td>${escapeHtml(incident.vulnerability ? incident.vulnerability.name : 'Неизвестная уязвимость')}</td>
            <td>${escapeHtml(incident.asset ? incident.asset.name : 'Неизвестный актив')}</td>
            <td>${escapeHtml(incident.operational_impact || 'Не указано')}</td>
            <td>${escapeHtml(incident.business_impact || 'Не указано')}</td>
            <td>${escapeHtml(displayImpactLevel || 'Не оценено')}</td>
            <td>${displayLikelihood}</td>
            <td>
                <span class="badge bg-${finalRiskLevel !== 'Не рассчитано' ? getRiskLevelColor(finalRiskLevel) : 'secondary'}">${finalRiskLevel}${calculatedRiskScore ? ` (${calculatedRiskScore})` : ''}</span>
            </td>
            <td>
                <span class="badge bg-${finalIsAcceptable ? 'success' : 'danger'}">${finalIsAcceptable ? 'Да' : 'Нет'}</span>
            </td>
            <td>
                ${risk ?
                    `<button class="btn btn-sm btn-outline-danger" onclick="deleteRisk(${risk.id})">Удалить</button>` :
                    `<button class="btn btn-sm btn-primary" onclick="createOrUpdateRisk(${incident.id})">Создать риск</button>`
                }
            </td>
        `;
        tbody.appendChild(row);
    });
}

function updateIncidentImpactLevel(incidentId, impactLevel) {
    fetch(`/api/incidents/${incidentId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ impact_level: impactLevel })
    })
    .then(response => response.json())
    .then(data => {
        showNotification('Уровень последствий обновлен', 'success');
        // Перезагружаем все данные из базы
        loadData();
    })
    .catch(error => {
        console.error('Ошибка обновления:', error);
        showNotification('Ошибка обновления уровня последствий', 'danger');
    });
}

function updateScenarioProbability(incidentId, probability) {
    if (!probability) return;
    
    fetch(`/api/incidents/${incidentId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ scenario_probability: parseInt(probability) })
    })
    .then(response => response.json())
    .then(data => {
        showNotification('Вероятность сценария обновлена', 'success');
        // Перезагружаем все данные из базы
        loadData();
    })
    .catch(error => {
        console.error('Ошибка обновления вероятности сценария:', error);
        showNotification('Ошибка обновления вероятности сценария', 'danger');
    });
}

function createOrUpdateRisk(incidentId) {
    const incident = incidents.find(i => i.id === incidentId);
    if (!incident) {
        showNotification('Инцидент не найден', 'danger');
        return;
    }

    // Проверяем, есть ли уже риск для этого инцидента
    let existingRisk = risks.find(r => r.incident_id === incidentId);

    const riskData = {
        incident_id: incidentId,
        impact_level: incident.impact_level,
        scenario_probability: incident.scenario_probability || 3, // Используем сохраненное значение или по умолчанию
        // Рассчитываем уровень риска по матрице
        risk_score: calculateRiskScore(incident.impact_level, getLikelihoodText(incident.scenario_probability || 3)),
        risk_level: getRiskLevel(calculateRiskScore(incident.impact_level, getLikelihoodText(incident.scenario_probability || 3)))
    };

    if (existingRisk) {
        // Обновляем существующий риск
        fetch(`/api/risks/${existingRisk.id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(riskData)
        })
        .then(response => response.json())
        .then(data => {
            showNotification('Риск обновлен', 'success');
            loadData(); // Перезагружаем данные
        })
        .catch(error => {
            console.error('Ошибка обновления риска:', error);
            showNotification('Ошибка обновления риска', 'danger');
        });
    } else {
        // Создаем новый риск
        fetch('/api/risks', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(riskData)
        })
        .then(response => response.json())
        .then(data => {
            showNotification('Риск создан', 'success');
            loadData(); // Перезагружаем данные
        })
        .catch(error => {
            console.error('Ошибка создания риска:', error);
            showNotification('Ошибка создания риска', 'danger');
        });
    }
}

function calculateAllRisks() {
    // Создаем риски для всех инцидентов, у которых есть уровень последствий
    const promises = incidents
        .filter(incident => incident.impact_level)
        .map(incident => createOrUpdateRisk(incident.id));

    Promise.all(promises)
        .then(() => {
            showNotification('Все риски рассчитаны', 'success');
            loadData();
        })
        .catch(error => {
            console.error('Ошибка расчета рисков:', error);
            showNotification('Ошибка расчета рисков', 'danger');
        });
}

function calculateRiskScore(impactLevel, likelihood) {
    console.log('calculateRiskScore called with:', {impactLevel, likelihood});
    // Матрица рисков (согласно таблице 3)
    // Строки: уровень последствий, Столбцы: вероятность
    const matrix = {
        'низкий': { 'низкая': 1, 'средняя': 2, 'высокая': 3 },
        'средний': { 'низкая': 2, 'средняя': 3, 'высокая': 4 },
        'высокий': { 'низкая': 3, 'средняя': 4, 'высокая': 5 }
    };

    console.log('Matrix:', JSON.stringify(matrix, null, 2));
    console.log('Looking up:', impactLevel, likelihood);
    console.log('Matrix[impactLevel]:', matrix[impactLevel]);
    console.log('Matrix[impactLevel][likelihood]:', matrix[impactLevel] ? matrix[impactLevel][likelihood] : 'undefined');

    let result;
    if (matrix[impactLevel] && matrix[impactLevel][likelihood] !== undefined) {
        result = matrix[impactLevel][likelihood];
    } else {
        console.log('Using default value 3');
        result = 3;
    }
    
    console.log('Final result:', result);
    return result;
}

function getRiskLevel(riskScore) {
    if (riskScore <= 2) return 'низкий';
    if (riskScore <= 4) return 'средний';
    return 'высокий';
}

function getLikelihoodText(probability) {
    console.log('getLikelihoodText called with:', probability);
    if (!probability) {
        console.log('Returning Не оценено');
        return 'Не оценено';
    }
    if (probability <= 2) {
        console.log('Returning низкая');
        return 'низкая';
    }
    if (probability <= 4) {
        console.log('Returning средняя');
        return 'средняя';
    }
    console.log('Returning высокая');
    return 'высокая';
}

function getRiskLevelColor(riskLevel) {
    switch(riskLevel) {
        case 'низкий': return 'success';
        case 'средний': return 'warning';
        case 'высокий': return 'danger';
        default: return 'secondary';
    }
}

function isRiskAcceptable(riskScore) {
    // Определяем уровень риска по баллу
    const riskLevel = getRiskLevel(riskScore);
    
    // Если есть критерии принятия риска из контекста - используем их
    if (riskAcceptanceCriteria) {
        console.log('Using risk acceptance criteria:', riskAcceptanceCriteria, 'for level:', riskLevel);
        
        if (riskLevel === 'низкий') {
            return riskAcceptanceCriteria.low === 'приемлемый';
        } else if (riskLevel === 'средний') {
            return riskAcceptanceCriteria.medium === 'приемлемый';
        } else if (riskLevel === 'высокий') {
            return riskAcceptanceCriteria.high === 'приемлемый';
        }
    }
    
    // По умолчанию: только низкий - приемлемый, средний и высокий - неприемлемый
    return riskScore <= 2;
}

function deleteRisk(id) {
    confirmDelete('Вы уверены, что хотите удалить этот риск?', () => {
        fetch(`/api/risks/${id}`, { method: 'DELETE' })
            .then(response => {
                if (response.ok) {
                    showNotification('Риск успешно удален', 'success');
                    loadData();
                } else {
                    showNotification('Ошибка при удалении риска', 'danger');
                }
            });
    });
}

function escapeHtml(text) {
    if (!text) return '';
    return text.toString()
        .replace(/&/g, "&")
        .replace(/</g, "<")
        .replace(/>/g, ">")
        .replace(/"/g, '"')
        .replace(/'/g, "'");
}

function showNotification(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.col-12');
    container.insertBefore(alertDiv, container.firstChild);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}