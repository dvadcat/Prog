{% extends "base.html" %}

{% block title %}Обработка рисков - Программное средство для оценки рисков ИБ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>Обработка рисков</h2>
        
        <div class="mb-3">
            <a href="{{ url_for('generate_report') }}" class="btn btn-primary me-2">Сгенерировать отчет</a>
            
        </div>
        

        <!-- Отчеты -->
        <div class="card">
            <div class="card-header">
                <h5>Отчеты</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Название</th>
                                <th>Область</th>
                                <th>Размер файла</th>
                                <th>Дата создания</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="reports-table-body">
                            <!-- Данные будут загружаться через JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Загрузка списка планов обработки
    fetchData('/api/treatment_plans')
        .then(data => {
            if (data) {
                const tbody = document.getElementById('treatments-table-body');
                tbody.innerHTML = '';
                
                data.forEach(plan => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${plan.id}</td>
                        <td>Инцидент #${plan.incident_id}</td>
                        <td>${plan.risk_treatment_measures || ''}</td>
                        <td>${plan.residual_risk || 'Не оценено'}</td>
                        <td>
                            <span class="badge bg-${plan.actions && plan.actions.includes('Выполнено') ? 'success' : 'warning'}">
                                ${plan.actions ? plan.actions : 'Не начато'}
                            </span>
                        </td>
                        <td>
                            <a href="${url_for('edit_treatment', treatment_id=plan.id)}" class="btn btn-sm btn-outline-primary">Изменить</a>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteTreatment(${plan.id})">Удалить</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
        });

    // Загрузка списка отчетов
    fetchData('/api/reports/')
        .then(data => {
            if (data) {
                const tbody = document.getElementById('reports-table-body');
                tbody.innerHTML = '';
                
                data.forEach(report => {
                    const row = document.createElement('tr');
                    const fileSize = report.file_size ? formatFileSize(report.file_size) : 'Неизвестно';
                    const createdDate = report.created_at ? new Date(report.created_at).toLocaleString('ru-RU') : 'Неизвестно';
                    
                    row.innerHTML = `
                        <td>${report.id}</td>
                        <td>${report.name}</td>
                        <td>${report.context_name || 'Не указан'}</td>
                        <td>${fileSize}</td>
                        <td>${createdDate}</td>
                        <td>
                            <a href="/api/reports/${report.id}/download" class="btn btn-sm btn-outline-success">Скачать</a>
                            <button class="btn btn-sm btn-outline-primary" onclick="editReport(${report.id})">Редактировать</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteReport(${report.id})">Удалить</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
        });
});

function deleteTreatment(id) {
    confirmDelete('Вы уверены, что хотите удалить этот план обработки?', () => {
        fetch(`/api/treatment_plans/${id}`, { method: 'DELETE' })
            .then(response => {
                if (response.ok) {
                    showNotification('План обработки успешно удален', 'success');
                    location.reload();
                } else {
                    showNotification('Ошибка при удалении плана обработки', 'danger');
                }
            });
    });
}

function deleteReport(id) {
    confirmDelete('Вы уверены, что хотите удалить этот отчет?', () => {
        fetch(`/api/reports/${id}`, { method: 'DELETE' })
            .then(response => {
                if (response.ok) {
                    showNotification('Отчет успешно удален', 'success');
                    location.reload();
                } else {
                    showNotification('Ошибка при удалении отчета', 'danger');
                }
            });
    });
}

function editReport(id) {
    // Переходим на страницу генерации отчетов с предзаполненными данными
    window.location.href = `/generate-report?edit_report_id=${id}`;
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function url_for(endpoint, params) {
    // Временная функция для генерации URL
    if (endpoint === 'edit_treatment') {
        return `/treatments/${params.treatment_id}/edit`;
    }
    return '#';
}
</script>
{% endblock %}