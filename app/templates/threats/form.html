{% extends "base.html" %}

{% block title %}{{ 'Редактирование угрозы' if threat else 'Создание угрозы' }} - Программное средство для оценки рисков ИБ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>{{ 'Редактирование угрозы' if threat else 'Создание угрозы' }}</h2>
        
        <form method="POST" id="threat-form">
            <div class="form-section">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="name" class="form-label">Наименование угрозы</label>
                            <input type="text" class="form-control" id="name" name="name" value="{{ threat.name if threat else '' }}" required list="threats-list">
                            <datalist id="threats-list">
                                <!-- Options will be populated by JavaScript from thrlist.xlsx -->
                            </datalist>
                        </div>
                        
                        <div class="mb-3">
                            <label for="source" class="form-label">Источник угрозы</label>
                            <input type="text" class="form-control" id="source" name="source" value="{{ threat.source if threat else '' }}" readonly>
                        </div>
                        
                        <div class="mb-3">
                            <label for="target_object" class="form-label">Объект воздействия</label>
                            <input type="text" class="form-control" id="target_object" name="target_object" value="{{ threat.target_object if threat else '' }}" readonly>
                        </div>
                        
                        <div class="mb-3">
                            <label for="likelihood" class="form-label">Вероятность реализации</label>
                            <select class="form-control" id="likelihood" name="likelihood">
                                <option value="" {% if not threat or not threat.likelihood %}selected{% endif %}>Не оценено</option>
                                <option value="низкая" {% if threat and threat.likelihood == 'низкая' %}selected{% endif %}>Низкая</option>
                                <option value="средняя" {% if threat and threat.likelihood == 'средняя' %}selected{% endif %}>Средняя</option>
                                <option value="высокая" {% if threat and threat.likelihood == 'высокая' %}selected{% endif %}>Высокая</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="description" class="form-label">Описание угрозы</label>
                            <textarea class="form-control" id="description" name="description" rows="4" readonly>{{ threat.description if threat else '' }}</textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Нарушение свойств ИБ</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="confidentiality_violation" name="confidentiality_violation" {% if threat and threat.confidentiality_violation %}checked{% endif %} disabled>
                                <label class="form-check-label" for="confidentiality_violation">Нарушение конфиденциальности</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="integrity_violation" name="integrity_violation" {% if threat and threat.integrity_violation %}checked{% endif %} disabled>
                                <label class="form-check-label" for="integrity_violation">Нарушение целостности</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="availability_violation" name="availability_violation" {% if threat and threat.availability_violation %}checked{% endif %} disabled>
                                <label class="form-check-label" for="availability_violation">Нарушение доступности</label>
                            </div>
                        </div>
                    </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="published_at" class="form-label">Дата публикации</label>
                            <input type="date" class="form-control" id="published_at" name="published_at" value="{{ threat.published_at if threat else '' }}" readonly>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="updated_at" class="form-label">Дата обновления</label>
                            <input type="date" class="form-control" id="updated_at" name="updated_at" value="{{ threat.updated_at if threat else '' }}" readonly>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="is_relevant" name="is_relevant" {% if threat and threat.is_relevant %}checked{% endif %}>
                    <label class="form-check-label" for="is_relevant"><strong>Актуальная угроза</strong> <small class="text-muted">(будет отображаться в выборе угроз для анализа и инцидентов)</small></label>
                </div>
                
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="imported_from_bdu" name="imported_from_bdu" {% if threat and threat.imported_from_bdu %}checked{% endif %} disabled>
                    <label class="form-check-label" for="imported_from_bdu">Импортировано из БДУ ФСТЭК</label>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary">{{ 'Сохранить изменения' if threat else 'Создать угрозу' }}</button>
            <a href="{{ url_for('threats_list') }}" class="btn btn-secondary">Отмена</a>
        </form>
    </div>
</div>

<script>
// Загрузка списка угроз из thrlist.xlsx для автодополнения
fetch('/api/threats/')
    .then(response => response.json())
    .then(threats => {
        const datalist = document.getElementById('threats-list');
        threats.forEach(threat => {
            const option = document.createElement('option');
            option.value = threat.name;
            option.dataset.description = threat.description || '';
            option.dataset.source = threat.source || '';
            option.dataset.target = threat.target_object || '';
            option.dataset.confidentiality = threat.confidentiality_violation ? '1' : '0';
            option.dataset.integrity = threat.integrity_violation ? '1' : '0';
            option.dataset.availability = threat.availability_violation ? '1' : '0';
            option.dataset.published = threat.published_at || '';
            option.dataset.updated = threat.updated_at || '';
            option.dataset.imported = threat.imported_from_bdu ? 'true' : 'false';
            datalist.appendChild(option);
        });
    })
    .catch(error => console.error('Ошибка загрузки угроз:', error));

// Обработчик изменения поля наименования угрозы
document.getElementById('name').addEventListener('change', function() {
    const selectedValue = this.value;
    const options = document.querySelectorAll('#threats-list option');
    
    options.forEach(option => {
        if (option.value === selectedValue) {
            // Заполняем поля информацией из thrlist.xlsx
            document.getElementById('description').value = option.dataset.description;
            document.getElementById('source').value = option.dataset.source;
            document.getElementById('target_object').value = option.dataset.target;
            
            // Устанавливаем чекбоксы нарушений
            document.getElementById('confidentiality_violation').checked = option.dataset.confidentiality === '1';
            document.getElementById('integrity_violation').checked = option.dataset.integrity === '1';
            document.getElementById('availability_violation').checked = option.dataset.availability === '1';
            
            // Устанавливаем даты
            document.getElementById('published_at').value = option.dataset.published;
            document.getElementById('updated_at').value = option.dataset.updated;
            
            // Устанавливаем чекбокс импорта
            document.getElementById('imported_from_bdu').checked = option.dataset.imported === 'true';
            
            // Делаем поля доступными для редактирования
            document.getElementById('description').removeAttribute('readonly');
            document.getElementById('source').removeAttribute('readonly');
            document.getElementById('target_object').removeAttribute('readonly');
            document.getElementById('confidentiality_violation').removeAttribute('disabled');
            document.getElementById('integrity_violation').removeAttribute('disabled');
            document.getElementById('availability_violation').removeAttribute('disabled');
            document.getElementById('published_at').removeAttribute('readonly');
            document.getElementById('updated_at').removeAttribute('readonly');
            document.getElementById('imported_from_bdu').removeAttribute('disabled');
        }
    });
});

document.getElementById('threat-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = {
        name: document.getElementById('name').value,
        description: document.getElementById('description').value,
        source: document.getElementById('source').value,
        target_object: document.getElementById('target_object').value,
        confidentiality_violation: document.getElementById('confidentiality_violation').checked,
        integrity_violation: document.getElementById('integrity_violation').checked,
        availability_violation: document.getElementById('availability_violation').checked,
        likelihood: document.getElementById('likelihood').value,
        published_at: document.getElementById('published_at').value || null,
        updated_at: document.getElementById('updated_at').value || null,
        imported_from_bdu: document.getElementById('imported_from_bdu').checked,
        is_relevant: document.getElementById('is_relevant').checked
    };
    
    // Преобразуем даты в правильный формат
    if (formData.published_at) {
        formData.published_at = new Date(formData.published_at).toISOString().split('T')[0];
    }
    if (formData.updated_at) {
        formData.updated_at = new Date(formData.updated_at).toISOString().split('T')[0];
    }
    
    const threatId = {{ threat.id if threat else 'null' }};
    let requestUrl, method;
    
    if (threatId) {
        // Редактирование
        requestUrl = `/api/threats/${threatId}`;
        method = 'PUT';
    } else {
        // Создание
        requestUrl = '/api/threats';
        method = 'POST';
    }
    
    fetch(requestUrl, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        } else {
            throw new Error('Ошибка при сохранении');
        }
    })
    .then(data => {
        showNotification('Угроза успешно сохранена', 'success');
        window.location.href = "{{ url_for('threats_list') }}";
    })
    .catch(error => {
        showNotification('Ошибка при сохранении угрозы', 'danger');
        console.error('Error:', error);
    });
});
</script>
{% endblock %}