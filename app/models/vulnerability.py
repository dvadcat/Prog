from app import db
from datetime import datetime

class Vulnerability(db.Model):
    __tablename__ = 'vulnerabilities'
    
    id = db.Column(db.Text, primary_key=True)  # идентификатор из БДУ ФСТЭК
    name = db.Column(db.Text, nullable=False)  # наименование уязвимости
    description = db.Column(db.Text)  # описание
    software_name = db.Column(db.Text)  # название ПО
    software_version = db.Column(db.Text)  # версия ПО
    vendor = db.Column(db.Text)  # вендор ПО
    platform = db.Column(db.Text)  # платформа
    discovered_at = db.Column(db.Date)  # дата выявления
    level = db.Column(db.Text)  # уровень опасности
    exploit_available = db.Column(db.Boolean, default=False)  # наличие эксплойта
    fix_info = db.Column(db.Text)  # информация об устранении
    cve = db.Column(db.Text)  # идентификаторы CVE
    cwe = db.Column(db.Text)  # тип ошибки CWE
    cvss_score = db.Column(db.Float)  # CVSS оценка
    imported_from_bdu = db.Column(db.Boolean, default=False)  # импортировано из БДУ ФСТЭК
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    
    # Связи
    asset_vulnerabilities = db.relationship('AssetVulnerability', backref='vulnerability', lazy=True, cascade='all, delete-orphan')
    incidents = db.relationship('Incident', backref='vulnerability', lazy=True, cascade='all, delete-orphan')
    vulnerability_assessments = db.relationship('VulnerabilityAssessment', backref='vulnerability', lazy=True, cascade='all, delete-orphan')
    
    def to_dict(self):
        return {
            'id': self.id,
            'name': self.name,
            'description': self.description,
            'software_name': self.software_name,
            'software_version': self.software_version,
            'vendor': self.vendor,
            'platform': self.platform,
            'discovered_at': self.discovered_at.isoformat() if self.discovered_at else None,
            'level': self.level,
            'exploit_available': self.exploit_available,
            'fix_info': self.fix_info,
            'cve': self.cve,
            'cwe': self.cwe,
            'cvss_score': self.cvss_score,
            'imported_from_bdu': self.imported_from_bdu,
            'created_at': self.created_at.isoformat() if self.created_at else None
        }