{% extends "base.html" %}

{% block title %}Оценка угроз - Программное средство для оценки рисков ИБ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>Оценка угроз</h2>
        
        <div id="selected-threats-info">
            <h3>Выбранные угрозы:</h3>
            <div id="threats-list"></div>
        </div>
        
        <div class="table-responsive mt-4">
            <h4>Описание угрозы</h4>
            <table id="threat-table-1" class="table table-striped">
                <thead>
                    <tr>
                        <th>Идентификатор</th>
                        <th>Наименование</th>
                        <th>Описание</th>
                        <th>Источник угрозы</th>
                        <th>Объект воздействия</th>
                        <th>Последствия</th>
                    </tr>
                </thead>
                <tbody id="threat-table-body-1">
                </tbody>
            </table>
        </div>
        
        <div class="table-responsive mt-4">
            <h4>Источники угрозы</h4>
            <table id="threat-sources-table" class="table table-striped">
                <thead>
                    <tr>
                        <th>Угроза</th>
                        <th>Источник угрозы</th>
                    </tr>
                </thead>
                <tbody id="threat-sources-body">
                </tbody>
            </table>
        </div>
        
        <div class="table-responsive mt-4">
            <h4>Объекты воздействия</h4>
            <table id="threat-targets-table" class="table table-striped">
                <thead>
                    <tr>
                        <th>Угроза</th>
                        <th>Объект воздействия</th>
                    </tr>
                </thead>
                <tbody id="threat-targets-body">
                </tbody>
            </table>
        </div>
        
        <div class="table-responsive mt-4">
            <h4>Последствия реализации угрозы</h4>
            <table id="consequences-table" class="table table-striped">
                <thead>
                    <tr>
                        <th>Угроза</th>
                        <th>Нарушение конфиденциальности</th>
                        <th>Нарушение целостности</th>
                        <th>Нарушение доступности</th>
                    </tr>
                </thead>
                <tbody id="consequences-body">
                </tbody>
            </table>
        </div>
        
        <div class="mt-4">
            <button class="btn btn-primary" onclick="proceedToNextStage()">Перейти к следующему этапу</button>
            <a href="{{ url_for('select_threats') }}" class="btn btn-secondary">Назад к выбору угроз</a>
        </div>
    </div>
</div>

<script>
    let selectedThreats = [];
    
    // Загружаем выбранные угрозы из localStorage
    window.onload = function() {
        const storedThreats = localStorage.getItem('selectedThreats');
        if (storedThreats) {
            selectedThreats = JSON.parse(storedThreats);
            renderThreatsInfo();
            populateTables();
        } else {
            // Если нет выбранных угроз, перенаправляем обратно
            alert('Не выбраны угрозы для оценки. Пожалуйста, вернитесь и выберите угрозы.');
            window.location.href = '{{ url_for("select_threats") }}';
        }
    };
    
    function renderThreatsInfo() {
        const threatsListDiv = document.getElementById('threats-list');
        threatsListDiv.innerHTML = '';
        
        selectedThreats.forEach((threat, index) => {
            const threatDiv = document.createElement('div');
            threatDiv.className = 'card mb-3';
            threatDiv.innerHTML = `
                <div class="card-body">
                    <h5 class="card-title">${escapeHtml(threat.name)}</h5>
                    <p class="card-text"><strong>Описание:</strong> ${escapeHtml(truncString(threat.description, 100)) || 'Нет описания'}</p>
                    <p class="card-text"><strong>Источник:</strong> ${escapeHtml(threat.source) || 'Не указан'}</p>
                    <p class="card-text"><strong>Объект воздействия:</strong> ${escapeHtml(threat.target_object) || 'Не указан'}</p>
                </div>
            `;
            threatsListDiv.appendChild(threatDiv);
        });
    }
    
    function populateTables() {
        const tableBody1 = document.getElementById('threat-table-body-1');
        const sourcesBody = document.getElementById('threat-sources-body');
        const targetsBody = document.getElementById('threat-targets-body');
        const consequencesBody = document.getElementById('consequences-body');
        
        tableBody1.innerHTML = '';
        sourcesBody.innerHTML = '';
        targetsBody.innerHTML = '';
        consequencesBody.innerHTML = '';
        
        selectedThreats.forEach(threat => {
            const row1 = document.createElement('tr');
            row1.innerHTML = `
                <td>${threat.bdu_id || threat.id}</td>
                <td>${escapeHtml(threat.name)}</td>
                <td>${escapeHtml(truncString(threat.description, 100))}</td>
                <td>${escapeHtml(threat.source)}</td>
                <td>${escapeHtml(threat.target_object)}</td>
                <td>
                    ${threat.confidentiality_violation ? 'Нарушение конфиденциальности<br/>' : ''}
                    ${threat.integrity_violation ? 'Нарушение целостности<br/>' : ''}
                    ${threat.availability_violation ? 'Нарушение доступности' : ''}
                </td>
            `;
            tableBody1.appendChild(row1);
            
            const sourceRow = document.createElement('tr');
            sourceRow.innerHTML = `
                <td>${escapeHtml(truncString(threat.name, 30))}</td>
                <td>${escapeHtml(threat.source)}</td>
            `;
            sourcesBody.appendChild(sourceRow);
            
            const targetRow = document.createElement('tr');
            targetRow.innerHTML = `
                <td>${escapeHtml(truncString(threat.name, 30))}</td>
                <td>${escapeHtml(threat.target_object)}</td>
            `;
            targetsBody.appendChild(targetRow);
            
            const consequenceRow = document.createElement('tr');
            consequenceRow.innerHTML = `
                <td>${escapeHtml(truncString(threat.name, 30))}</td>
                <td>${threat.confidentiality_violation ? 'Да' : 'Нет'}</td>
                <td>${threat.integrity_violation ? 'Да' : 'Нет'}</td>
                <td>${threat.availability_violation ? 'Да' : 'Нет'}</td>
            `;
            consequencesBody.appendChild(consequenceRow);
        });
    }
    
    function escapeHtml(text) {
        if (!text) return '';
        return text.toString()
            .replace(/&/g, "&")
            .replace(/</g, "<")
            .replace(/>/g, ">")
            .replace(/"/g, """)
            .replace(/'/g, "&#039;");
    }
    
    function truncString(str, maxLength) {
        if (!str) return '';
        return str.length > maxLength ? str.substring(0, maxLength) + '...' : str;
    }
    
    function proceedToNextStage() {
        // Сохраняем выбранные угрозы для следующего этапа
        localStorage.setItem('selectedThreats', JSON.stringify(selectedThreats));
        // Перенаправляем на следующий этап - таблицу 5 (соответствие между активами и угрозами)
        window.location.href = '{{ url_for("asset_threat_mapping") }}';
    }
</script>
{% endblock %}