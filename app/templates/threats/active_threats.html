{% extends "base.html" %}

{% block title %}Актуальные угрозы активов - Программное средство для оценки рисков ИБ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>Перечень актуальных угроз ИБ активов</h2>
        
        <div class="alert alert-info">
            <p>Перечень актуальных угроз ИБ активов. На основе сопоставления активов и угроз формируется перечень актуальных угроз для каждого актива.</p>
        </div>
        
        <div class="table-responsive mt-4">
            <h4>Перечень актуальных угроз ИБ активов</h4>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Актив</th>
                        <th>Тип актива</th>
                        <th>Угрозы</th>
                    </tr>
                </thead>
                <tbody id="active-threats-body">
                    <!-- Содержимое таблицы будет генерироваться динамически -->
                </tbody>
            </table>
        </div>
        
        <div class="mt-4">
            <button class="btn btn-primary" onclick="proceedToNextStage()">Перейти к следующему этапу</button>
            <a href="{{ url_for('asset_threat_mapping') }}" class="btn btn-secondary">Назад к сопоставлению</a>
        </div>
    </div>
</div>

<script>
    let assets = [];
    let selectedThreats = [];
    let mappingData = {};
    
    // Загружаем данные из localStorage
    window.onload = function() {
        const storedAssets = localStorage.getItem('assets');
        const storedThreats = localStorage.getItem('selectedThreats');
        const storedMapping = localStorage.getItem('assetThreatMapping');
        
        if (storedAssets && storedThreats && storedMapping) {
            assets = JSON.parse(storedAssets);
            selectedThreats = JSON.parse(storedThreats);
            mappingData = JSON.parse(storedMapping);
            
            generateActiveThreatsTable();
        } else {
            alert('Недостаточно данных для формирования таблицы актуальных угроз. Пожалуйста, вернитесь и завершите предыдущие этапы.');
            window.location.href = '{{ url_for("select_threats") }}';
        }
    };
    
    function generateActiveThreatsTable() {
        const tableBody = document.getElementById('active-threats-body');
        tableBody.innerHTML = '';
        
        // Группируем угрозы по активам
        const assetThreatsMap = {};
        
        // Сначала формируем список угроз для каждого актива
        assets.forEach(asset => {
            assetThreatsMap[asset.id] = {
                asset: asset,
                threats: []
            };
        });
        
        // Проходим по каждому типу актива и сопоставляем угрозы
        for (const threatId in mappingData) {
            const threat = selectedThreats.find(t => t.id == threatId);
            if (!threat) continue;
            
            for (const assetType in mappingData[threatId]) {
                const assetIds = mappingData[threatId][assetType];
                
                assetIds.forEach(assetId => {
                    if (assetThreatsMap[assetId]) {
                        assetThreatsMap[assetId].threats.push(threat);
                    }
                });
            }
        }
        
        // Рендерим таблицу
        for (const assetId in assetThreatsMap) {
            const assetInfo = assetThreatsMap[assetId];
            if (assetInfo.threats.length > 0) {  // Показываем только активы с угрозами
                const row = document.createElement('tr');
                
                // Собираем названия угроз
                const threatNames = assetInfo.threats.map(t => t.name).join(', ');
                
                // Определяем тип актива
                const assetType = assetInfo.asset.category || 'Информационные';
                
                row.innerHTML = `
                    <td>${escapeHtml(assetInfo.asset.name)}</td>
                    <td>${escapeHtml(assetType)}</td>
                    <td>${escapeHtml(threatNames)}</td>
                `;
                
                tableBody.appendChild(row);
            }
        }
        
        // Если нет ни одной актуальной угрозы, добавляем сообщение
        if (tableBody.children.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td colspan="3" class="text-center">Нет актуальных угроз для выбранных активов</td>
            `;
            tableBody.appendChild(row);
        }
    }
    
    function escapeHtml(text) {
        if (!text) return '';
        return text.toString()
            .replace(/&/g, "&")
            .replace(/</g, "<")
            .replace(/>/g, ">")
            .replace(/"/g, """)
            .replace(/'/g, "&#039;");
    }
    
    function proceedToNextStage() {
        // Сохраняем данные для следующего этапа
        localStorage.setItem('assets', JSON.stringify(assets));
        localStorage.setItem('selectedThreats', JSON.stringify(selectedThreats));
        localStorage.setItem('activeThreats', JSON.stringify(generateActiveThreatsArray()));
        
        // Перенаправляем на следующий этап - таблицу 7 (оценка признака "Источник угрозы ИБ")
        window.location.href = '{{ url_for("threat_source_assessment") }}';
    }
    
    // Функция для генерации массива активных угроз
    function generateActiveThreatsArray() {
        const activeThreats = [];
        
        // Группируем угрозы по активам
        const assetThreatsMap = {};
        
        assets.forEach(asset => {
            assetThreatsMap[asset.id] = {
                asset: asset,
                threats: []
            };
        });
        
        // Сопоставляем угрозы с активами
        for (const threatId in mappingData) {
            const threat = selectedThreats.find(t => t.id == threatId);
            if (!threat) continue;
            
            for (const assetType in mappingData[threatId]) {
                const assetIds = mappingData[threatId][assetType];
                
                assetIds.forEach(assetId => {
                    if (assetThreatsMap[assetId]) {
                        assetThreatsMap[assetId].threats.push(threat);
                    }
                });
            }
        }
        
        // Формируем итоговый массив
        for (const assetId in assetThreatsMap) {
            const assetInfo = assetThreatsMap[assetId];
            if (assetInfo.threats.length > 0) {
                activeThreats.push({
                    asset: assetInfo.asset,
                    threats: assetInfo.threats
                });
            }
        }
        
        return activeThreats;
    }
</script>
{% endblock %}