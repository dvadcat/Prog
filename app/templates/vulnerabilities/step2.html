{% extends "base.html" %}

{% block title %}Качественная шкала{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>Создание качественной шкалы оценки уязвимостей</h2>

        <form id="scale-form">
            <div id="levels-container">
                <div class="mb-3">
                    <label class="form-label">Низкий уровень</label>
                    <textarea class="form-control" placeholder="Описание низкого уровня" id="level-desc-1">Уязвимость существует у актива в минимальной степени и имеет минимальную возможность реализации источником угроз ИБ</textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Средний уровень</label>
                    <textarea class="form-control" placeholder="Описание среднего уровня" id="level-desc-2">Уязвимость существует у актива частично и без значительных затруднений может быть использована источником угроз ИБ для реализации</textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Высокий уровень</label>
                    <textarea class="form-control" placeholder="Описание высокого уровня" id="level-desc-3">Уязвимость существует у актива в максимальной степени и легко может быть использована источником угроз ИБ для реализации</textarea>
                </div>
            </div>
            <button type="button" class="btn btn-success" onclick="saveScale()">Сохранить шкалу и перейти далее</button>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Загружаем сохраненную шкалу из базы данных
    loadSavedScale();
});

function loadSavedScale() {
    fetch('/api/vulnerabilities/get-vulnerability-scale')
        .then(response => response.json())
        .then(data => {
            if (data && data.length > 0) {
                // Заполняем форму сохраненными значениями
                data.forEach((item, index) => {
                    const textarea = document.getElementById(`level-desc-${index + 1}`);
                    if (textarea && item.description) {
                        textarea.value = item.description;
                    }
                });
            }
        })
        .catch(error => {
            console.error('Ошибка загрузки шкалы:', error);
        });
}

function saveScale() {
    const levels = [
        { name: 'Низкий', description: document.getElementById('level-desc-1').value.trim() },
        { name: 'Средний', description: document.getElementById('level-desc-2').value.trim() },
        { name: 'Высокий', description: document.getElementById('level-desc-3').value.trim() }
    ];

    // Сохраняем в localStorage
    localStorage.setItem('vulnerability_scale', JSON.stringify(levels));
    
    // Пытаемся сохранить в базу данных (необязательно, но полезно)
    fetch('/api/vulnerabilities/get-vulnerability-scale')
        .then(response => response.json())
        .then(data => {
            // Если есть данные в localStorage, сохраняем их в базу
            const savedData = localStorage.getItem('vulnerability_table');
            if (savedData) {
                const tableData = JSON.parse(savedData);
                if (tableData.length > 0) {
                    const assetId = tableData[0].asset_id;
                    fetch('/api/vulnerabilities/save-vulnerability-scale', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ scale: levels, asset_id: assetId })
                    });
                }
            }
        })
        .catch(error => {
            console.error('Ошибка сохранения шкалы в БД:', error);
        });
    
    showNotification('Шкала сохранена', 'success');
    window.location.href = '/vulnerabilities/step3';
}
</script>
{% endblock %}