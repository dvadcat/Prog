{% extends "base.html" %}

{% block title %}Оценка ценности активов{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2>Оценка ценности активов</h2>
            
            <div class="card">
                <div class="card-header">
                    <h5>Выбор актива и типа</h5>
                </div>
                <div class="card-body">
                    <form id="asset-selection-form">
                        <div class="mb-3">
                            <label for="asset" class="form-label">Выберите актив:</label>
                            <select class="form-control" id="asset" name="asset_id" required>
                                <option value="">-- Выберите актив --</option>
                                {% for asset in assets %}
                                <option value="{{ asset.id }}" data-type="{{ asset.type }}">
                                    {{ asset.name }} ({{ asset.type }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="asset-type" class="form-label">Тип актива:</label>
                            <select class="form-control" id="asset-type" name="type" required>
                                <option value="information">Информационные активы</option>
                                <option value="software">Программные средства</option>
                                <option value="hardware">Аппаратные средства</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="asset-description" class="form-label">Описание актива:</label>
                            <textarea class="form-control" id="asset-description" name="description" placeholder="Введите описание актива"></textarea>
                        </div>
                        
                        <button type="button" class="btn btn-primary" onclick="showStep2()">Далее</button>
                    </form>
                </div>
            </div>

            <div id="step2" class="card mt-3" style="display: none;">
                <div class="card-header">
                    <h5>Выбор критериев влияния рисков</h5>
                </div>
                <div class="card-body">
                    <p><strong>Критерии влияния рисков ИБ для организации «Видеоигруха»:</strong></p>
                    <ul>
                        <li>нарушение законодательных требований</li>
                        <li>нарушение функционирования бизнес-процессов</li>
                        <li>финансовые потери</li>
                        <li>негативные последствия для репутации («неосязаемого капитала»)</li>
                    </ul>
                    
                    <p><strong>Критерии оценивания рисков ИБ:</strong></p>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Качественный критерий оценивания риска</th>
                                <th>Низкий уровень риска</th>
                                <th>Средний уровень риска</th>
                                <th>Высокий уровень риска</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Количественный критерий оценивания риска</td>
                                <td>До 40,0 тыс. руб.</td>
                                <td>От 40,0 до 200,0 тыс. руб.</td>
                                <td>От 200,0 до 900,0 тыс. руб.</td>
                            </tr>
                        </tbody>
                    </table>
                    <p>Приемлемым считается низкий уровень риска, средний и высокий уровень риска считаются неприемлемыми.</p>
                    
                    <form id="risk-criteria-form">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="business_process" value="business_process" onchange="toggleScaleForm('business_process')">
                            <label class="form-check-label" for="business_process">Нарушение функционирования бизнес-процессов</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="legal_requirements" value="legal_requirements" onchange="toggleScaleForm('legal_requirements')">
                            <label class="form-check-label" for="legal_requirements">Нарушение законодательных требований</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="financial_losses" value="financial_losses" onchange="toggleScaleForm('financial_losses')">
                            <label class="form-check-label" for="financial_losses">Финансовые потери</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="reputation" value="reputation" onchange="toggleScaleForm('reputation')">
                            <label class="form-check-label" for="reputation">Негативные последствия для репутации</label>
                        </div>
                        
                        <button type="button" class="btn btn-primary" onclick="showStep4()">Далее</button>
                        <button type="button" class="btn btn-secondary" onclick="showStep1()">Назад</button>
                    </form>
                </div>
            </div>

            <!-- Формы для шкал оценки ущерба (таблицы 4-7) -->
            <div id="business_process_scale" class="card mt-3" style="display: none;">
                <div class="card-header">
                    <h5>Шкала для определения величины ущерба - Функционирование бизнес-процессов</h5>
                </div>
                <div class="card-body">
                    <p><strong>Шкала для определения величины ущерба при нарушении свойств ИБ актива в соответствии с влиянием на функционирование бизнес-процессов:</strong></p>
                    <div class="mb-3">
                        <label class="form-label">Минимальная величина ущерба:</label>
                        <textarea class="form-control" id="business_low_desc" placeholder="Нарушение процессов деятельности, в которых задействован актив, не происходит">Нарушение процессов деятельности, в которых задействован актив, не происходит</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Средняя величина ущерба:</label>
                        <textarea class="form-control" id="business_mid_desc" placeholder="Определение среднего ущерба">Возможно нарушение процессов деятельности, в которых актив задействован. Виды основной деятельности, в рамках которых функционируют указанные процессы, не нарушаются</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Высокая величина ущерба:</label>
                        <textarea class="form-control" id="business_high_desc" placeholder="Определение высокого ущерба">Возможно нарушение процессов деятельности, в которых актив задействован. Возможно нарушение некоторых (отдельных) видов основной деятельности, реализуемых данными процессами</textarea>
                    </div>
                </div>
            </div>

            <div id="legal_scale" class="card mt-3" style="display: none;">
                <div class="card-header">
                    <h5>Шкала для определения величины ущерба - Нарушение законодательных требований</h5>
                </div>
                <div class="card-body">
                    <p><strong>Шкала для определения величины ущерба при нарушении свойств ИБ актива в соответствии с влиянием на соблюдение законодательных требований:</strong></p>
                    <div class="mb-3">
                        <label class="form-label">Минимальная величина ущерба:</label>
                        <textarea class="form-control" id="legal_low_desc" placeholder="Определение минимального ущерба">Нарушение свойства ИБ актива не приводит к нарушению законодательных требований</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Средняя величина ущерба:</label>
                        <textarea class="form-control" id="legal_mid_desc" placeholder="Определение среднего ущерба">Нарушение свойства ИБ актива приводит к нарушению законодательных требований, в результате чего к сотрудникам организации могут быть применены дисциплинарные и(или) материальные меры наказания</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Высокая величина ущерба:</label>
                        <textarea class="form-control" id="legal_high_desc" placeholder="Определение высокого ущерба">Нарушение свойства ИБ актива приводит к нарушению законодательных требований, в результате чего возможны судебные иски к организации</textarea>
                    </div>
                </div>
            </div>

            <div id="financial_scale" class="card mt-3" style="display: none;">
                <div class="card-header">
                    <h5>Шкала для определения величины ущерба - Финансовые потери</h5>
                </div>
                <div class="card-body">
                    <p><strong>Шкала для определения величины ущерба при нарушении свойств ИБ актива в соответствии с влиянием на финансовые потери:</strong></p>
                    <div class="mb-3">
                        <label class="form-label">Минимальная величина ущерба:</label>
                        <textarea class="form-control" id="financial_low_desc" placeholder="Определение минимального ущерба">Нарушение свойства ИБ актива не приводит к финансовым потерям</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Средняя величина ущерба:</label>
                        <textarea class="form-control" id="financial_mid_desc" placeholder="Определение среднего ущерба">Нарушение свойства ИБ актива может привести к небольшим финансовым потерям</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Высокая величина ущерба:</label>
                        <textarea class="form-control" id="financial_high_desc" placeholder="Определение высокого ущерба">Нарушение свойства ИБ актива приводит к финансовым потерям</textarea>
                    </div>
                </div>
            </div>

            <div id="reputation_scale" class="card mt-3" style="display: none;">
                <div class="card-header">
                    <h5>Шкала для определения величины ущерба - Негативные последствия репутации</h5>
                </div>
                <div class="card-body">
                    <p><strong>Шкала для определения величины ущерба при нарушении свойств ИБ актива в соответствии с влиянием на негативные последствия репутации:</strong></p>
                    <div class="mb-3">
                        <label class="form-label">Минимальная величина ущерба:</label>
                        <textarea class="form-control" id="reputation_low_desc" placeholder="Определение минимального ущерба">Нарушение свойства ИБ актива не приводит к потери репутации</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Средняя величина ущерба:</label>
                        <textarea class="form-control" id="reputation_mid_desc" placeholder="Определение среднего ущерба">Нарушение свойства ИБ актива может привести к потери репутации, в следствии чего организации необходимо пойти на уступки клиентам</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Высокая величина ущерба:</label>
                        <textarea class="form-control" id="reputation_high_desc" placeholder="Определение высокого ущерба">Нарушение свойства ИБ актива приводит к потери репутации, ведет к необратимым последствиям</textarea>
                    </div>
                </div>
            </div>

            <div id="step3" class="card mt-3" style="display: none;">
                <div class="card-header">
                    <h5>Определение свойств ИБ для актива</h5>
                </div>
                <div class="card-body">
                    <p><strong>Требуемые свойства информационной безопасности для активов:</strong></p>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Актив</th>
                                <th>Конфиденциальность</th>
                                <th>Целостность</th>
                                <th>Доступность</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td id="current-asset-name">Выбранный актив</td>
                                <td>
                                    <select class="form-select" id="confidentiality" name="confidentiality">
                                        <option value="-">-</option>
                                        <option value="+">+</option>
                                    </select>
                                </td>
                                <td>
                                    <select class="form-select" id="integrity" name="integrity">
                                        <option value="-">-</option>
                                        <option value="+">+</option>
                                    </select>
                                </td>
                                <td>
                                    <select class="form-select" id="availability" name="availability">
                                        <option value="-">-</option>
                                        <option value="+">+</option>
                                    </select>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <form id="security-properties-form">
                        <button type="button" class="btn btn-primary" onclick="showStep4()">Далее</button>
                        <button type="button" class="btn btn-secondary" onclick="showStep2()">Назад</button>
                    </form>
                </div>
            </div>

            <div id="step4" class="card mt-3" style="display: none;">
                <div class="card-header">
                    <h5>Оценка воздействия на свойства ИБ</h5>
                </div>
                <div class="card-body">
                    <p><strong>Шкала определения ценности актива:</strong></p>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Качественная шкала</th>
                                <th>Минимальная ценность</th>
                                <th>Средняя ценность</th>
                                <th>Высокая ценность</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Количественная шкала</td>
                                <td>До 20,0 тыс. руб.</td>
                                <td>От 20,0 до 100,0 тыс. руб.</td>
                                <td>От 100,0 до 400,0 тыс. руб.</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="mb-3">
                        <h6>Конфиденциальность</h6>
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Критерий</th>
                                    <th>Минимальная</th>
                                    <th>Средняя</th>
                                    <th>Высокая</th>
                                    <th>Выбрано</th>
                                </tr>
                            </thead>
                            <tbody id="confidentiality-impacts">
                                <tr id="confidentiality-business">
                                    <td>Функционирование бизнес-процессов</td>
                                    <td><input type="radio" name="confidentiality_business" value="Н"> Н</td>
                                    <td><input type="radio" name="confidentiality_business" value="С"> С</td>
                                    <td><input type="radio" name="confidentiality_business" value="В"> В</td>
                                    <td><select class="form-control form-select-sm" onchange="updateMaxImpact('confidentiality', 'business')">
                                        <option value="">-</option>
                                        <option value="Н">Низкий</option>
                                        <option value="С">Средний</option>
                                        <option value="В">Высокий</option>
                                    </select></td>
                                </tr>
                                <tr id="confidentiality-legal">
                                    <td>Законодательные требования</td>
                                    <td><input type="radio" name="confidentiality_legal" value="Н"> Н</td>
                                    <td><input type="radio" name="confidentiality_legal" value="С"> С</td>
                                    <td><input type="radio" name="confidentiality_legal" value="В"> В</td>
                                    <td><select class="form-control form-select-sm" onchange="updateMaxImpact('confidentiality', 'legal')">
                                        <option value="">-</option>
                                        <option value="Н">Низкий</option>
                                        <option value="С">Средний</option>
                                        <option value="В">Высокий</option>
                                    </select></td>
                                </tr>
                                <tr id="confidentiality-financial">
                                    <td>Финансовые потери</td>
                                    <td><input type="radio" name="confidentiality_financial" value="Н"> Н</td>
                                    <td><input type="radio" name="confidentiality_financial" value="С"> С</td>
                                    <td><input type="radio" name="confidentiality_financial" value="В"> В</td>
                                    <td><select class="form-control form-select-sm" onchange="updateMaxImpact('confidentiality', 'financial')">
                                        <option value="">-</option>
                                        <option value="Н">Низкий</option>
                                        <option value="С">Средний</option>
                                        <option value="В">Высокий</option>
                                    </select></td>
                                </tr>
                                <tr id="confidentiality-reputation">
                                    <td>Репутация</td>
                                    <td><input type="radio" name="confidentiality_reputation" value="Н"> Н</td>
                                    <td><input type="radio" name="confidentiality_reputation" value="С"> С</td>
                                    <td><input type="radio" name="confidentiality_reputation" value="В"> В</td>
                                    <td><select class="form-control form-select-sm" onchange="updateMaxImpact('confidentiality', 'reputation')">
                                        <option value="">-</option>
                                        <option value="Н">Низкий</option>
                                        <option value="С">Средний</option>
                                        <option value="В">Высокий</option>
                                    </select></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mb-3">
                        <h6>Целостность</h6>
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Критерий</th>
                                    <th>Минимальная</th>
                                    <th>Средняя</th>
                                    <th>Высокая</th>
                                    <th>Выбрано</th>
                                </tr>
                            </thead>
                            <tbody id="integrity-impacts">
                                <tr id="integrity-business">
                                    <td>Функционирование бизнес-процессов</td>
                                    <td><input type="radio" name="integrity_business" value="Н"> Н</td>
                                    <td><input type="radio" name="integrity_business" value="С"> С</td>
                                    <td><input type="radio" name="integrity_business" value="В"> В</td>
                                    <td><select class="form-control form-select-sm" onchange="updateMaxImpact('integrity', 'business')">
                                        <option value="">-</option>
                                        <option value="Н">Низкий</option>
                                        <option value="С">Средний</option>
                                        <option value="В">Высокий</option>
                                    </select></td>
                                </tr>
                                <tr id="integrity-legal">
                                    <td>Законодательные требования</td>
                                    <td><input type="radio" name="integrity_legal" value="Н"> Н</td>
                                    <td><input type="radio" name="integrity_legal" value="С"> С</td>
                                    <td><input type="radio" name="integrity_legal" value="В"> В</td>
                                    <td><select class="form-control form-select-sm" onchange="updateMaxImpact('integrity', 'legal')">
                                        <option value="">-</option>
                                        <option value="Н">Низкий</option>
                                        <option value="С">Средний</option>
                                        <option value="В">Высокий</option>
                                    </select></td>
                                </tr>
                                <tr id="integrity-financial">
                                    <td>Финансовые потери</td>
                                    <td><input type="radio" name="integrity_financial" value="Н"> Н</td>
                                    <td><input type="radio" name="integrity_financial" value="С"> С</td>
                                    <td><input type="radio" name="integrity_financial" value="В"> В</td>
                                    <td><select class="form-control form-select-sm" onchange="updateMaxImpact('integrity', 'financial')">
                                        <option value="">-</option>
                                        <option value="Н">Низкий</option>
                                        <option value="С">Средний</option>
                                        <option value="В">Высокий</option>
                                    </select></td>
                                </tr>
                                <tr id="integrity-reputation">
                                    <td>Репутация</td>
                                    <td><input type="radio" name="integrity_reputation" value="Н"> Н</td>
                                    <td><input type="radio" name="integrity_reputation" value="С"> С</td>
                                    <td><input type="radio" name="integrity_reputation" value="В"> В</td>
                                    <td><select class="form-control form-select-sm" onchange="updateMaxImpact('integrity', 'reputation')">
                                        <option value="">-</option>
                                        <option value="Н">Низкий</option>
                                        <option value="С">Средний</option>
                                        <option value="В">Высокий</option>
                                    </select></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mb-3">
                        <h6>Доступность</h6>
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Критерий</th>
                                    <th>Минимальная</th>
                                    <th>Средняя</th>
                                    <th>Высокая</th>
                                    <th>Выбрано</th>
                                </tr>
                            </thead>
                            <tbody id="availability-impacts">
                                <tr id="availability-business">
                                    <td>Функционирование бизнес-процессов</td>
                                    <td><input type="radio" name="availability_business" value="Н"> Н</td>
                                    <td><input type="radio" name="availability_business" value="С"> С</td>
                                    <td><input type="radio" name="availability_business" value="В"> В</td>
                                    <td><select class="form-control form-select-sm" onchange="updateMaxImpact('availability', 'business')">
                                        <option value="">-</option>
                                        <option value="Н">Низкий</option>
                                        <option value="С">Средний</option>
                                        <option value="В">Высокий</option>
                                    </select></td>
                                </tr>
                                <tr id="availability-legal">
                                    <td>Законодательные требования</td>
                                    <td><input type="radio" name="availability_legal" value="Н"> Н</td>
                                    <td><input type="radio" name="availability_legal" value="С"> С</td>
                                    <td><input type="radio" name="availability_legal" value="В"> В</td>
                                    <td><select class="form-control form-select-sm" onchange="updateMaxImpact('availability', 'legal')">
                                        <option value="">-</option>
                                        <option value="Н">Низкий</option>
                                        <option value="С">Средний</option>
                                        <option value="В">Высокий</option>
                                    </select></td>
                                </tr>
                                <tr id="availability-financial">
                                    <td>Финансовые потери</td>
                                    <td><input type="radio" name="availability_financial" value="Н"> Н</td>
                                    <td><input type="radio" name="availability_financial" value="С"> С</td>
                                    <td><input type="radio" name="availability_financial" value="В"> В</td>
                                    <td><select class="form-control form-select-sm" onchange="updateMaxImpact('availability', 'financial')">
                                        <option value="">-</option>
                                        <option value="Н">Низкий</option>
                                        <option value="С">Средний</option>
                                        <option value="В">Высокий</option>
                                    </select></td>
                                </tr>
                                <tr id="availability-reputation">
                                    <td>Репутация</td>
                                    <td><input type="radio" name="availability_reputation" value="Н"> Н</td>
                                    <td><input type="radio" name="availability_reputation" value="С"> С</td>
                                    <td><input type="radio" name="availability_reputation" value="В"> В</td>
                                    <td><select class="form-control form-select-sm" onchange="updateMaxImpact('availability', 'reputation')">
                                        <option value="">-</option>
                                        <option value="Н">Низкий</option>
                                        <option value="С">Средний</option>
                                        <option value="В">Высокий</option>
                                    </select></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mb-3">
                        <label>Максимальная ценность актива (автоматически рассчитывается):</label>
                        <input type="text" class="form-control" id="max-impact-value" readonly>
                    </div>
                    
                    <button type="button" class="btn btn-primary" onclick="saveSecurityPropertyImpacts()">Сохранить оценки</button>
                    <button type="button" class="btn btn-secondary" onclick="showStep2()">Назад</button>
                </div>
            </div>

            <div id="step5" class="card mt-3" style="display: none;">
                <div class="card-header">
                    <h5>Определение стоимости актива</h5>
                </div>
                <div class="card-body">
                    <p><strong>Шкала стоимости актива:</strong></p>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Качественная шкала</th>
                                <th>Минимальная стоимость</th>
                                <th>Средняя стоимость</th>
                                <th>Высокая стоимость</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Количественная шкала</td>
                                <td>До 20,0 тыс. руб.</td>
                                <td>От 20,0 до 100,0 тыс. руб.</td>
                                <td>От 100,0 до 40,0 тыс. руб.</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <p><strong>Стоимость актива:</strong></p>
                    <form id="asset-cost-form">
                        <div class="mb-3">
                            <label for="asset-cost" class="form-label">Стоимость актива (тыс. руб.):</label>
                            <input type="number" class="form-control" id="asset-cost" name="asset_cost" step="0.01" placeholder="Введите стоимость">
                        </div>
                        
                        <div class="mb-3">
                            <label for="dependency-value" class="form-label">Ценность с учетом зависимостей:</label>
                            <select class="form-control" id="dependency-value" name="dependency_value">
                                <option value="">-- Выберите --</option>
                                <option value="низкая">Низкая</option>
                                <option value="средняя">Средняя</option>
                                <option value="высокая">Высокая</option>
                            </select>
                        </div>
                        
                        <button type="button" class="btn btn-success" onclick="calculateFinalValue()">Рассчитать итоговую ценность</button>
                        <button type="button" class="btn btn-secondary" onclick="showStep4()">Назад</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentStep = 1;
let selectedCriteria = [];
let securityPropertyImpacts = {};

function showStep1() {
    document.getElementById('step2').style.display = 'none';
    document.getElementById('step3').style.display = 'none';
    document.getElementById('step4').style.display = 'none';
    document.getElementById('step5').style.display = 'none';
    document.getElementById('business_process_scale').style.display = 'none';
    document.getElementById('legal_scale').style.display = 'none';
    document.getElementById('financial_scale').style.display = 'none';
    document.getElementById('reputation_scale').style.display = 'none';
    currentStep = 1;
}

function showStep2() {
    const assetId = document.getElementById('asset').value;
    if (!assetId) {
        alert('Пожалуйста, выберите актив');
        return;
    }
    
    document.getElementById('step2').style.display = 'block';
    currentStep = 2;
}

function showStep3() {
    // Обновляем название актива в таблице
    const assetSelect = document.getElementById('asset');
    const selectedOption = assetSelect.options[assetSelect.selectedIndex];
    const assetName = selectedOption.text.split(' (')[0]; // Убираем тип актива из названия
    document.getElementById('current-asset-name').textContent = assetName;
    
    document.getElementById('step2').style.display = 'none';
    document.getElementById('step3').style.display = 'block';
    currentStep = 3;
}

function showStep4() {
    // Пропускаем шаг 3 и сразу переходим к шагу 4
    document.getElementById('step2').style.display = 'none';
    document.getElementById('step3').style.display = 'none';
    document.getElementById('step4').style.display = 'block';
    currentStep = 4;
}

function showStep5() {
    document.getElementById('step4').style.display = 'none';
    document.getElementById('step5').style.display = 'block';
    currentStep = 5;
}

function calculateFinalValue() {
    const assetId = document.getElementById('asset').value;
    const assetCost = document.getElementById('asset-cost').value;
    const dependencyValue = document.getElementById('dependency-value').value;
    
    // Получаем максимальное значение из критериев воздействия
    const maxValueFromImpacts = document.getElementById('max-impact-value').value;
    
    // Определяем оценку стоимости актива на основе введенной стоимости
    let costRating = '';
    if (assetCost) {
        // Обновляем стоимость актива
        fetch(`/api/asset-values/asset-cost/${assetId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ cost: parseFloat(assetCost) })
        });
        
        // Определяем рейтинг стоимости на основе введенной суммы
        const cost = parseFloat(assetCost);
        if (cost <= 20) {
            costRating = 'низкая';
        } else if (cost <= 100) {
            costRating = 'средняя';
        } else {
            costRating = 'высокая';
        }
    }
    
    // Получаем все активы для анализа их ценности без зависимостей
    fetch('/api/assets/')
        .then(response => response.json())
        .then(allAssets => {
            // Получаем зависимости
            return fetch('/api/asset-dependencies/')
                .then(response => response.json())
                .then(dependencies => {
                    // Проверяем зависимости выбранного актива
                    const assetDependencies = dependencies.filter(dep => dep.asset_id == assetId);
                    
                    // Ценность без зависимостей остается неизменной (это независимая характеристика)
                    let valueWithoutDependencies = maxValueFromImpacts || 'Средняя';
                    
                    // Если у актива есть зависимости, проверяем максимальную ценность связанных активов
                    let finalDependencyValue = dependencyValue;
                    if (assetDependencies.length > 0) {
                        // Собираем все связанные активы (сам актив + активы, от которых он зависит)
                        const relatedAssetIds = [parseInt(assetId)];
                        assetDependencies.forEach(dep => {
                            relatedAssetIds.push(dep.depends_on_asset_id);
                        });
                        
                        // Находим максимальную ценность без зависимостей среди всех связанных активов
                        let maxPriority = 2; // Средняя = 2 по умолчанию
                        const priorityMap = { 'Низкая': 1, 'Средняя': 2, 'Высокая': 3 };
                        let maxValueWithoutDependencies = valueWithoutDependencies;
                        
                        allAssets.forEach(asset => {
                            if (relatedAssetIds.includes(asset.id) && asset.value_without_dependencies) {
                                // Преобразуем значение актива в формат для сравнения
                                let assetValueForComparison = asset.value_without_dependencies;
                                if (asset.value_without_dependencies === 'Н') assetValueForComparison = 'Низкая';
                                else if (asset.value_without_dependencies === 'С') assetValueForComparison = 'Средняя';
                                else if (asset.value_without_dependencies === 'В') assetValueForComparison = 'Высокая';
                                
                                const assetPriority = priorityMap[assetValueForComparison] || 2;
                                if (assetPriority > maxPriority) {
                                    maxPriority = assetPriority;
                                    maxValueWithoutDependencies = assetValueForComparison;
                                }
                            }
                        });
                        
                        // Если максимальная ценность связанных активов выше, обновляем dependency_value
                        if (maxValueWithoutDependencies !== valueWithoutDependencies) {
                            if (maxValueWithoutDependencies === 'Высокая') finalDependencyValue = 'высокая';
                            else if (maxValueWithoutDependencies === 'Средняя') finalDependencyValue = 'средняя';
                            else if (maxValueWithoutDependencies === 'Низкая') finalDependencyValue = 'низкая';
                        }
                    } else {
                        // Если зависимостей нет, очищаем dependency_value
                        finalDependencyValue = null;
                    }
                    
                    // Определяем "Ценность без зависимостей" как максимальное значение
                    // из максимального значения из критериев воздействия и оценки стоимости
                    let finalValueWithoutDependencies = valueWithoutDependencies;
                    
                    // Преобразуем значения для сравнения
                    const impactPriority = { 'Низкая': 1, 'Средняя': 2, 'Высокая': 3 };
                    const costPriority = { 'низкая': 1, 'средняя': 2, 'высокая': 3 };
                    
                    if (maxValueFromImpacts && costRating) {
                        // Сопоставляем значения для сравнения
                        let maxValueForComparison = maxValueFromImpacts;
                        if (maxValueFromImpacts === 'Н') maxValueForComparison = 'Низкая';
                        else if (maxValueFromImpacts === 'С') maxValueForComparison = 'Средняя';
                        else if (maxValueFromImpacts === 'В') maxValueForComparison = 'Высокая';
                        
                        // Сравниваем и берем максимальное
                        if (impactPriority[maxValueForComparison] >= costPriority[costRating]) {
                            finalValueWithoutDependencies = maxValueFromImpacts;
                        } else {
                            // Преобразуем обратно к формату Н/С/В
                            if (costRating === 'низкая') finalValueWithoutDependencies = 'Н';
                            else if (costRating === 'средняя') finalValueWithoutDependencies = 'С';
                            else if (costRating === 'высокая') finalValueWithoutDependencies = 'В';
                        }
                    } else if (maxValueFromImpacts) {
                        finalValueWithoutDependencies = maxValueFromImpacts;
                    } else if (costRating) {
                        // Преобразуем costRating к формату Н/С/В
                        if (costRating === 'низкая') finalValueWithoutDependencies = 'Н';
                        else if (costRating === 'средняя') finalValueWithoutDependencies = 'С';
                        else if (costRating === 'высокая') finalValueWithoutDependencies = 'В';
                    }
                    
                    // Рассчитываем итоговую ценность
                    return fetch(`/api/asset-values/final-value/${assetId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            value_without_dependencies: finalValueWithoutDependencies,
                            cost_rating: costRating,
                            dependency_value: finalDependencyValue
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Сохраняем результат в таблицу 14 (результаты определения ценности активов)
                            const finalValue = data.asset.final_value || finalDependencyValue || finalValueWithoutDependencies;
                            saveAssetValueResult(assetId, finalValue);
                        }
                    });
                });
        })
        .catch(error => {
            console.error('Ошибка:', error);
            alert('Ошибка при расчете ценности актива');
        });
}

// Функция для сохранения результатов оценки в таблицу 14
function saveAssetValueResult(assetId, finalValue) {
    // Значение "Ценность без зависимостей" уже вычислено в calculateFinalValue
    // как максимальное из "максимального значения из критериев воздействия" и "оценки стоимости"
    // Для доступа к этому значению, мы можем вынести переменную в глобальную область
    // или повторно вычислить. Повторим вычисление для надежности.
    
    // Получаем максимальное значение из критериев воздействия
    const maxValueFromImpacts = document.getElementById('max-impact-value').value;
    
    // Получаем введенную стоимость актива
    const assetCostInput = document.getElementById('asset-cost');
    const assetCost = assetCostInput ? assetCostInput.value : null;
    
    // Определяем оценку стоимости актива на основе введенной стоимости
    let costRating = '';
    if (assetCost) {
        const cost = parseFloat(assetCost);
        if (cost <= 20) {
            costRating = 'низкая';
        } else if (cost <= 100) {
            costRating = 'средняя';
        } else {
            costRating = 'высокая';
        }
    }
    
    // Определяем "Ценность без зависимостей" как максимальное значение
    // из максимального значения из критериев воздействия и оценки стоимости
    let valueWithoutDependencies = maxValueFromImpacts;
    
    // Преобразуем значения для сравнения
    const impactPriority = { 'Низкая': 1, 'Средняя': 2, 'Высокая': 3 };
    const costPriority = { 'низкая': 1, 'средняя': 2, 'высокая': 3 };
    
    if (maxValueFromImpacts && costRating) {
        // Сопоставляем значения для сравнения
        let maxValueForComparison = maxValueFromImpacts;
        if (maxValueFromImpacts === 'Н') maxValueForComparison = 'Низкая';
        else if (maxValueFromImpacts === 'С') maxValueForComparison = 'Средняя';
        else if (maxValueFromImpacts === 'В') maxValueForComparison = 'Высокая';
        
        // Сравниваем и берем максимальное
        if (impactPriority[maxValueForComparison] >= costPriority[costRating]) {
            valueWithoutDependencies = maxValueFromImpacts;
        } else {
            // Преобразуем обратно к формату Н/С/В
            if (costRating === 'низкая') valueWithoutDependencies = 'Н';
            else if (costRating === 'средняя') valueWithoutDependencies = 'С';
            else if (costRating === 'высокая') valueWithoutDependencies = 'В';
        }
    } else if (maxValueFromImpacts) {
        valueWithoutDependencies = maxValueFromImpacts;
    } else if (costRating) {
        // Преобразуем costRating к формату Н/С/В
        if (costRating === 'низкая') valueWithoutDependencies = 'Н';
        else if (costRating === 'средняя') valueWithoutDependencies = 'С';
        else if (costRating === 'высокая') valueWithoutDependencies = 'В';
    }
    
    fetch(`/api/asset-value-results/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            asset_id: assetId,
            value_without_dependencies: valueWithoutDependencies,
            value_with_dependencies: finalValue,
            final_value: finalValue
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data) {
            alert('Оценка ценности актива завершена успешно! Результаты сохранены.');
            location.reload();
        }
    });
}

// Функция для переключения видимости шкал оценки
function toggleScaleForm(criterion) {
    const checkbox = document.getElementById(criterion.replace('_', '-'));
    const scaleDiv = document.getElementById(criterion + '_scale');
    
    if (checkbox.checked) {
        scaleDiv.style.display = 'block';
        // Добавляем критерий в список выбранных
        if (!selectedCriteria.includes(criterion)) {
            selectedCriteria.push(criterion);
        }
    } else {
        scaleDiv.style.display = 'none';
        // Убираем критерий из списка выбранных
        selectedCriteria = selectedCriteria.filter(item => item !== criterion);
    }
}

// Функция для обновления максимального воздействия
function updateMaxImpact(property, criterion) {
    const select = document.querySelector(`#${property}-${criterion} select`);
    const value = select.value;
    
    if (!securityPropertyImpacts[property]) {
        securityPropertyImpacts[property] = {};
    }
    securityPropertyImpacts[property][criterion] = value;
    
    // Рассчитываем максимальное значение для актива
    let maxValue = '';
    const allValues = [];
    
    for (let prop in securityPropertyImpacts) {
        for (let crit in securityPropertyImpacts[prop]) {
            if (securityPropertyImpacts[prop][crit]) {
                allValues.push(securityPropertyImpacts[prop][crit]);
            }
        }
    }
    
    if (allValues.includes('В')) {
        maxValue = 'Высокая';
    } else if (allValues.includes('С')) {
        maxValue = 'Средняя';
    } else if (allValues.includes('Н')) {
        maxValue = 'Низкая';
    }
    
    document.getElementById('max-impact-value').value = maxValue;
}

// Функция для сохранения оценок свойств ИБ
function saveSecurityPropertyImpacts() {
    const assetId = document.getElementById('asset').value;
    const criteria = [];
    
    // Собираем оценки для каждого критерия воздействия
    for (let criterion of selectedCriteria) {
        let criterionId;
        let criterionName;
        switch(criterion) {
            case 'business_process':
                criterionId = 1;
                criterionName = 'business';
                break;
            case 'legal_requirements':
                criterionId = 2;
                criterionName = 'legal';
                break;
            case 'financial_losses':
                criterionId = 3;
                criterionName = 'financial';
                break;
            case 'reputation':
                criterionId = 4;
                criterionName = 'reputation';
                break;
        }
        
        if (criterionId) {
            const criterionData = {
                criterion_id: criterionId,
                confidentiality_impact: document.querySelector(`#confidentiality-${criterionName} select`).value,
                integrity_impact: document.querySelector(`#integrity-${criterionName} select`).value,
                availability_impact: document.querySelector(`#availability-${criterionName} select`).value
            };
            criteria.push(criterionData);
        }
    }
    
    // Отправляем данные на сервер
    fetch(`/api/asset-values/impact-assessment/${assetId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            criteria: criteria
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Оценки свойств ИБ сохранены успешно!');
            showStep5();
        }
    });
}

// Обновляем тип актива при выборе
document.getElementById('asset').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const assetType = selectedOption.getAttribute('data-type');
    if (assetType) {
        document.getElementById('asset-type').value = assetType;
    }
});
</script>
{% endblock %}